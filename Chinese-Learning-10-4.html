<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>國文主題探索 單元10 中文量詞(Firebase雲端版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React & Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18/?dev",
            "react-dom/client": "https://esm.sh/react-dom@18/client/?dev",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* 基礎設定 */
        body { 
            font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif; 
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #fcf9f2;
        }
        
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); }
        ::-webkit-scrollbar-thumb { background: #d4c4a8; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #b09b7c; }
        
        /* 動畫定義 */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        
        @keyframes fade-in-up { 
            0% { opacity: 0; transform: translateY(20px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        
       /* 跑馬燈動畫 */
        @keyframes marquee {
            0% { left: 100%; transform: translateX(0); }
            100% { left: 0; transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 30s linear infinite; 
            white-space: nowrap;
            display: inline-block;
            position: absolute; 
            top: 50%;
            margin-top: -0.6em; 
        }

        /* 禁止選取文字 */
        .no-select { user-select: none; -webkit-user-select: none; }

        /* 表格響應式優化 */
        .table-container { overflow-x: auto; }
        .prose-table td, .prose-table th { white-space: pre-wrap; min-width: 120px; }
        
        /* 音量滑桿自訂樣式 */
        .volume-slider {
            -webkit-appearance: none;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #FF8800;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .volume-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* 雲端狀態燈號 */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .status-loading { background-color: #fbbf24; animation: pulse 1.5s infinite; }
        .status-success { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 列印專用樣式 */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0; /* 控制由 CSS 處理 */
            }
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm; /* A4 width */
                font-family: "標楷體", "DFKai-SB", serif;
            }
            .a4-page {
                width: 210mm;
                height: 297mm; /* A4 height */
                padding: 20mm;
                page-break-after: always;
                position: relative;
                overflow: hidden;
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useImperativeHandle, forwardRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, collection, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        // ==========================================
        //  Firebase 設定
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
            authDomain: "chinese-learning-47f4d.firebaseapp.com",
            projectId: "chinese-learning-47f4d",
            storageBucket: "chinese-learning-47f4d.firebasestorage.app",
            messagingSenderId: "76289812052",
            appId: "1:76289812052:web:898384a916f9f341f62fc1"
        };

        // Firebase Initialization
        let db;
        let auth;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;
            }
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        // ==========================================
        //  常數與資料
        // ==========================================
        const COLLECTION_NAME = 'Chinese-Learning-10'; 
        const DOC_GLOBAL = 'global_users';
        const MUSIC_CONFIG = { username: 'nicktsai88', repo: 'Music', folder: '' };
        const ITEMS_PER_PAGE = 20;

        // --- 量詞資料庫 ---
        const c = (id, term, def, scene = "") => ({
            id, 
            term, 
            definition: def, 
            sentence1: def, 
            sentence2: def.replace(new RegExp(term, 'g'), "____"), 
            scene 
        });

        const c_complex = (id, term, fullDef, examples, scene = "") => ({
            id,
            term, 
            definition: fullDef,
            sentence1: examples,
            sentence2: examples.replace(new RegExp(term, 'g'), "____"),
            scene
        });

        const IDIOM_DATA = [
            c(1, "幫", "一幫人馬（相當於「班」）"),
            c(2, "部", "一部辭典、一部摩托車、三部電影"),
            c(3, "班", "三班飛機、輪三班工作"),
            c(4, "筆", "畫幾筆潑墨山水、一筆錢"),
            c(5, "把", "一把眼淚、一把刀、兩把傘、一把蔥、拉你一把、一把無名火"),
            c_complex(6, "撇", "ㄆㄧㄝˇ：兩撇鬍子", "兩撇鬍子"),
            c(7, "票", "一票人、一票買賣"),
            c(8, "批", "一批旅客、三批木材"),
            c_complex(9, "匹", "ㄆㄧˇ：一匹布、兩匹綢子\nㄆㄧ：兩匹驢、單槍匹馬", "一匹布、兩匹綢子、兩匹驢、單槍匹馬"),
            c_complex(10, "泡", "ㄆㄠ：撒一泡尿\nㄆㄠˋ：第二泡茶", "撒一泡尿、第二泡茶"),
            c(11, "碼", "兩碼事"),
            c(12, "抹", "一抹浮雲、一抹餘暉"),
            c(13, "面", "一面國旗、兩面鏡子"),
            c(14, "枚", "一枚炸彈、一枚口罩、一枚銅板"),
            c(15, "門", "一門功課、兩門技術、一門忠烈"),
            c(16, "幅", "一幅油畫、三幅掛圖"),
            c(17, "副", "一副碗筷、一副對聯、三副眼鏡"),
            c(18, "方", "匾額一方、一方手帕、三方圖章"),
            c(19, "番", "白費一番苦心、三番兩次"),
            c(20, "堵", "一堵牆"),
            c(21, "頓", "一頓飯、痛打一頓"),
            c(22, "對", "一對鐲子、三對夫妻"),
            c(23, "碟", "兩碟瓜子、三碟醬油"),
            c(24, "頂", "一頂草帽、十頂大轎"),
            c(25, "檔", "作了三檔秀、為了這檔事"),
            c(26, "刀", "劃了幾刀、一刀稿紙（紙一百張為一刀）"),
            c(27, "段", "一段路、一段情、一段時間"),
            c(28, "道", "一道菜、兩道門、一道手續、一道閃電、下一道命令、十道題目"),
            c_complex(29, "帖", "ㄊㄧㄝˇ：一帖中藥", "一帖中藥"),
            c_complex(30, "罈", "ㄊㄢˊ：一罈醬菜、兩罈酒", "一罈醬菜、兩罈酒"),
            c_complex(31, "坨", "ㄊㄨㄛˊ：一坨糞便、兩坨土", "一坨糞便、兩坨土"),
            c(32, "套", "一套理論、兩套洋裝"),
            c(33, "趟", "去過三趟、打了幾趟拳"),
            c(34, "團", "一團毛線、兩團泥巴"),
            c(35, "輪", "一輪明月（滿月）、年紀差了一輪（十二年為一輪）"),
            c(36, "領", "一領被子"),
            c(37, "列", "一列火車、一列士兵"),
            c_complex(38, "綹", "ㄌㄧㄡˇ：一綹頭髮、三綹絲線", "一綹頭髮、三綹絲線"),
            c_complex(39, "縷", "ㄌㄩˇ：一縷炊煙、一縷頭髮", "一縷炊煙、一縷頭髮"),
            c(40, "股", "一股勁、一股幽香"),
            c(41, "貫", "家財萬貫（一千制錢串在一起，稱為「一貫錢」）"),
            c(42, "棵", "一棵樹"),
            c(43, "顆", "一顆糖果、一顆花生、三顆子彈（相當於「發」）"),
            c(44, "刻", "六點一刻（十五分鐘為一刻）"),
            c(45, "客", "兩客牛排"),
            c(46, "口", "一家五口、一口枯井"),
            c_complex(47, "捆", "ㄎㄨㄣˇ：兩捆木材、十捆報紙", "兩捆木材、十捆報紙"),
            c(48, "伙", "兩伙人"),
            c(49, "回", "我去找過她兩回、這是兩回事"),
            c_complex(50, "行", "ㄏㄤˊ：兩行樹、一目十行", "兩行樹、一目十行"),
            c(51, "級", "兩百級階梯"),
            c(52, "局", "一局棋、對弈兩局"),
            c(53, "節", "三節車廂、兩節課、本文分三節"),
            c(54, "截", "一截甘蔗、斷成兩截"),
            c(55, "劑", "兩劑（帖）中藥、一劑疫苗"),
            c(56, "記", "一記悶棍、一記左勾拳"),
            c(57, "莖", "小草幾莖、捻斷幾莖鬚"),
            c(58, "鈞", "千鈞一髮（三十斤為一鈞）"),
            c(59, "介", "一介書生、一介平民"),
            c(60, "具", "棺材兩具、一具屍體、五具電話"),
            c(61, "架", "兩架電視機、五架機器、十架飛機"),
            c_complex(62, "卷", "ㄐㄩㄢˇ：一卷衛生紙、兩卷底片\nㄐㄩㄢˋ：讀書破萬卷", "一卷衛生紙、兩卷底片、讀書破萬卷"),
            c_complex(63, "畦", "ㄑㄧˊ：一畦沃土、一畦菜園", "一畦沃土、一畦菜園"),
            c(64, "球", "一球冰淇淋、三球毛線"),
            c(65, "起", "一起車禍、兩起案件"),
            c_complex(66, "闋", "ㄑㄩㄝˋ：一闋詞（計算詞、曲的單位）", "一闋詞"),
            c(67, "旬", "上旬（十天為一旬）、八旬老翁（十年為一旬）"),
            c(68, "巡", "酒過三巡（相當於「遍」）"),
            c(69, "席", "一席話、三席名額"),
            c(70, "襲", "一襲新衣、一襲洋裝"),
            c(71, "盞", "一盞燈"),
            c(72, "炷", "三炷香"),
            c(73, "鍾", "書中自有千鍾粟（容量單位）"),
            c_complex(74, "盅", "ㄓㄨㄥ：一盅好酒、兩盅湯（小杯子）", "一盅好酒、兩盅湯"),
            c(75, "陣", "一陣風、一陣騷動"),
            c_complex(76, "幀", "ㄓㄥˋ：一幀山水畫（相當於「幅」）", "一幀山水畫"),
            c(77, "椿", "一椿婚事、小事一椿"),
            c(78, "周", "環島一周、繞場一周"),
            c(79, "針", "打了一針止痛劑、縫了五針"),
            c_complex(80, "齣", "ㄔㄨ：一齣戲", "一齣戲"),
            c(81, "床", "兩床棉被"),
            c_complex(82, "幢", "ㄔㄨㄤˊ：一幢房子（相當於「棟」）", "一幢房子"),
            c(83, "串", "兩串念珠、一串銅錢"),
            c(84, "束", "一束鮮花"),
            c_complex(85, "乘", "ㄕㄥˋ：千乘之國（車輛單位）", "千乘之國"),
            c(86, "舍", "退避三舍（三十里為一舍）"),
            c(87, "扇", "兩扇門板、一扇窗子"),
            c(88, "手", "寫一手好字、彈一手好琴"),
            c(89, "仞", "萬仞高山（八尺為一仞，一說七尺）"),
            c(90, "遭", "頭一遭（相當於「回」）"),
            c_complex(91, "載", "ㄗㄞˇ：千載難逢（相當於「年」）", "千載難逢"),
            c(92, "宗", "一宗非法買賣"),
            c(93, "座", "兩座山、一座鐘"),
            c(94, "則", "一則新聞、一則寓言"),
            c(95, "尊", "三尊佛像、五尊大炮"),
            c_complex(96, "錙銖", "ㄗ ㄓㄨ：錙銖必較（十分輕微）", "錙銖必較"),
            c_complex(97, "撮", "ㄘㄨㄛˋ：兩撮頭髮、幾撮鹽、一撮土", "兩撮頭髮、幾撮鹽、一撮土"),
            c(98, "艘", "十艘船、兩艘軍艦"),
            c(99, "葉", "一葉扁舟（小船）"),
            c(100, "尾", "兩尾魚（相當於「條」）"),
            c(101, "彎", "一彎新月（弦月）"),
            c(102, "味", "加一味止咳化痰的藥"),
            c(103, "員", "一員健將（相當於「名」）"),
            c(104, "個", "一個人、一個便當"),
            c(105, "位", "一位老師、一位客人"),
            c(106, "名", "一名警員、一名傷者"),
            c(107, "隻", "一隻狗、一隻手套"),
            c(108, "頭", "一頭牛、一頭大象"),
            c(109, "匹", "一匹馬、一匹布"),
            c(110, "條", "一條魚、一條繩子"),
            c(111, "根", "一根頭髮、一根吸管"),
            c(112, "枝", "一枝筆、一枝花 (有梗的)"),
            c(113, "支", "一支手機、一支隊伍"),
            c(114, "管", "一管牙膏、一管針筒"),
            c(115, "桿", "一桿槍、一桿秤"),
            c(116, "張", "一張紙、一張桌子"),
            c(117, "面", "一面鏡子、一面牆"),
            c(118, "片", "一片吐司、一片葉子"),
            c(119, "塊", "一塊蛋糕、一塊石頭"),
            c(120, "顆", "一顆糖果、一顆心"),
            c(121, "粒", "一粒米、一粒沙"),
            c(122, "把", "一把剪刀、一把傘"),
            c(123, "柄", "一柄劍、一柄斧頭"),
            c(124, "雙", "一雙筷子、一雙鞋"),
            c(125, "對", "一對耳環、一對夫妻"),
            c(126, "副", "一副眼鏡、一副撲克牌"),
            c(127, "套", "一套西裝、一套系統"),
            c(128, "件", "一件衣服、一件事情"),
            c(129, "頂", "一頂帽子、一頂帳篷"),
            c(130, "領", "一領草蓆"),
            c(131, "身", "一身冷汗、一身新衣"),
            c(132, "床", "一床棉被"),
            c(133, "輛", "一輛汽車、一輛腳踏車"),
            c(134, "台", "一台電腦、一台電視"),
            c(135, "部", "一部電影、一部機器"),
            c(136, "架", "一架飛機、一架鋼琴"),
            c(137, "艘", "一艘船、一艘軍艦"),
            c(138, "列", "一列火車"),
            c(139, "排", "一排座位、一排牙齒"),
            c(140, "行", "一行字、一行白鷺"),
            c(141, "串", "一串葡萄、一串鑰匙"),
            c(142, "束", "一束鮮花、一束光"),
            c(143, "朵", "一朵雲、一朵花"),
            c(144, "瓣", "一瓣橘子、一瓣花瓣"),
            c(145, "株", "一株幼苗"),
            c(146, "棵", "一棵大樹"),
            c(147, "叢", "一叢雜草"),
            c(148, "簇", "一簇花團"),
            c(149, "本", "一本書、一本帳簿"),
            c(150, "冊", "一冊畫集"),
            c(151, "卷", "一卷底片、手不釋卷"),
            c(152, "篇", "一篇文章、一篇報導"),
            c(153, "章", "一章法規"),
            c(154, "則", "一則新聞、一則笑話"),
            c(155, "幅", "一幅畫、一幅對聯"),
            c(156, "幀", "一幀照片"),
            c(157, "首", "一首歌、一首詩"),
            c(158, "闕", "一闕詞 (文學用語)"),
            c(159, "句", "一句話"),
            c(160, "封", "一封信、一封郵件"),
            c(161, "份", "一份報紙、一份早餐"),
            c(162, "杯", "一杯水、一杯咖啡"),
            c(163, "瓶", "一瓶酒、一瓶醬油"),
            c(164, "壺", "一壺茶"),
            c(165, "罐", "一罐可樂、一罐奶粉"),
            c(166, "盒", "一盒喜餅、一盒面紙"),
            c(167, "箱", "一箱水果"),
            c(168, "包", "一包餅乾、一包衛生紙"),
            c(169, "袋", "一袋米"),
            c(170, "籃", "一籃雞蛋"),
            c(171, "桶", "一桶水"),
            c(172, "碗", "一碗麵"),
            c(173, "盤", "一盤餃子、一盤棋"),
            c(174, "碟", "一碟小菜"),
            c(175, "鍋", "一鍋湯"),
            c(176, "匙", "一匙鹽"),
            c(177, "勺", "一勺油"),
            c(178, "瓢", "一瓢水"),
            c(179, "桌", "一桌酒席、一桌菜"),
            c(180, "席", "一席話、一席之地"),
            c(181, "味", "一味藥、一味珍饈"),
            c(182, "帖", "一帖中藥"),
            c(183, "劑", "一劑疫苗、一劑強心針"),
            c(184, "發", "一發子彈、一發砲彈"),
            c(185, "門", "一門學問、一門大砲"),
            c(186, "尊", "一尊佛像、一尊神像"),
            c(187, "座", "一座山、一座橋"),
            c(188, "棟", "一棟房子、一棟大樓"),
            c(189, "幢", "一幢別墅 (較少用，同棟)"),
            c(190, "間", "一間臥室、一間店面"),
            c(191, "所", "一所學校、一所醫院"),
            c(192, "家", "一家公司、一家餐廳"),
            c(193, "戶", "一戶人家"),
            c(194, "層", "一層樓、一層灰塵"),
            c(195, "級", "一級階梯"),
            c(196, "階", "一階樓梯"),
            c(197, "扇", "一扇門、一扇窗"),
            c(198, "堵", "一堵牆"),
            c(199, "道", "一道彩虹、一道菜、一道命令"),
            c(200, "盞", "一盞燈"),
            c(201, "口", "一口井、一口棺材、一口氣"),
            c(202, "眼", "一眼泉水"),
            c(203, "襲", "一襲長裙 (文學用語)"),
            c(204, "具", "一具屍體、一具棺木"),
            c(205, "枚", "一枚硬幣、一枚戒指"),
            c(206, "截", "一截木頭"),
            c(207, "段", "一段往事、一段路"),
            c(208, "節", "一節車廂、一節課"),
            c(209, "項", "一項任務、一項記錄"),
            c(210, "宗", "一宗搶案、一宗買賣"),
            c(211, "樁", "一樁心事、一樁婚事"),
            c(212, "筆", "一筆錢、一筆生意"),
            c(213, "款", "一款新型手機"),
            c(214, "種", "一種感覺、一種口味"),
            c(215, "樣", "一樣禮物、各式各樣"),
            c(216, "類", "一類人"),
            c(217, "般", "這般光景 (文學用語)"),
            c(218, "群", "一群羊、一群學生"),
            c(219, "夥", "一夥搶匪"),
            c(220, "幫", "一幫人馬"),
            c(221, "堆", "一堆垃圾、一堆書"),
            c(222, "疊", "一疊鈔票、一疊文件"),
            c(223, "落", "一落書 (讀音ㄌㄨㄛˋ)"),
            c(224, "些", "一些時間"),
            c(225, "點", "一點意見、一點心意"),
            c(226, "滴", "一滴水、一滴眼淚"),
            c(227, "絲", "一絲微笑、一絲希望"),
            c(228, "縷", "一縷輕煙、一縷幽魂"),
            c(229, "股", "一股清流、一股味道"),
            c(230, "抹", "一抹斜陽、一抹紅暈"),
            c(231, "道", "一道閃電"),
            c(232, "陣", "一陣風、一陣雨"),
            c(233, "場", "一場夢、一場比賽"),
            c(234, "通", "一通電話"),
            c(235, "次", "去過一次"),
            c(236, "回", "第五回、一回生二回熟"),
            c(237, "趟", "跑一趟、走一趟"),
            c(238, "遍", "唸一遍、看一遍"),
            c(239, "遭", "走一遭"),
            c(240, "番", "一番話、一番好意"),
            c(241, "頓", "一頓飯、一頓打"),
            c(242, "下", "打一下、親一下"),
            c(243, "拳", "打了一拳"),
            c(244, "腳", "踢了一腳"),
            c(245, "把", "幫一把 (助詞/量詞通用)"),
            c(246, "秒", "一秒鐘"),
            c(247, "分", "一分鐘"),
            c(248, "刻", "一刻鐘、此時此刻"),
            c(249, "時", "一個時辰"),
            c(250, "天", "一天"),
            c(251, "週", "一週"),
            c(252, "年", "一年"),
            c(253, "世", "一世英名、三生三世"),
            c(254, "齣", "一齣戲、一齣鬧劇"),
            c(255, "折", "一折戲 (戲曲段落)"),
            c(256, "幕", "第一幕、一幕場景"),
            c(257, "輯", "第一輯、一輯照片"),
            c(258, "期", "一期雜誌、一期工程"),
            c(259, "版", "頭版新聞、一版廣告"),
            c(260, "聯", "一聯對聯"),
            c(261, "挺", "一挺機關槍"),
            c(262, "軸", "一軸山水畫"),
            c(263, "錠", "一錠銀元、一錠墨"),
            c(264, "丸", "一丸藥、一丸泥"),
            c(265, "紮", "一紮鮮花、一紮鈔票"),
            c(266, "綑", "一綑木柴、一綑舊報紙"),
            c(267, "撮", "一撮鹽、一撮毛髮"),
            c(268, "抔", "一抔黃土 (形容墳墓)"),
            c(269, "掬", "一掬笑容、一掬同情淚"),
            c(270, "捧", "一捧清泉、一捧土"),
            c(271, "抱", "一抱草、一抱之木"),
            c(272, "握", "一握之砂、掌握之中"),
            c(273, "指", "一指寬、下五指棋"),
            c(274, "掌", "打一巴掌、一掌打死"),
            c(275, "臂", "一臂之力"),
            c_complex(276, "覺", "ㄐㄧㄠˋ：睡一覺", "睡一覺"),
            c_complex(277, "宿", "ㄒㄧㄡˇ：住一宿", "住一宿"),
            c(278, "曲", "一曲肝腸斷、一曲相思"),
            c(279, "窩", "一窩小狗、一窩蜂"),
            c(280, "票", "一票人、幹一票大的"),
            c(281, "團", "一團毛線、一團和氣"),
            c(282, "族", "一族人、上班族"),
            c(283, "幫", "一幫兄弟 (同夥)"),
            c(284, "罈", "一罈紹興酒、一罈醋"),
            c(285, "甕", "一甕醬菜、甕中捉鱉"),
            c(286, "缸", "一缸金魚、一缸水"),
            c(287, "籠", "一籠小籠包、一籠鳥"),
            c(288, "盅", "一盅雞湯"),
            c_complex(289, "泓", "一泓清泉 (形容水深且清)", "一泓清泉"),
            c(290, "輪", "一輪明月、一輪猛攻"),
            c(291, "彎", "一彎新月、一彎眉毛"),
            c_complex(292, "葉", "一葉扁舟 (形容船小如葉)", "一葉扁舟"),
            c(293, "方", "一方印章、一方水土"),
            c_complex(294, "坵", "一坵田 (台灣常用田地單位)", "一坵田"),
            c(295, "畦", "一畦菜圃"),
            c(296, "壟", "一壟地"),
            c(297, "派", "一派日光、一派胡言"),
            c(298, "屆", "第一屆、一屆畢業生"),
            c(299, "任", "一任縣長、連任兩屆"),
            c(300, "代", "一代宗師、富二代"),
            c(301, "季", "一季稻作、下一季"),
            c(302, "度", "一度電、一年一度"),
            c_complex(303, "咖", "一咖皮箱 (台灣口語：個)", "一咖皮箱")
        ];

        // --- Icons ---
        const icons = {
            check: <polyline points="20 6 9 17 4 12" />,
            play: <polygon points="5 3 19 12 5 21 5 3" />,
            pause: <><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>,
            book: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
            menu: <><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>,
            left: <polyline points="15 18 9 12 15 6"/>,
            heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>,
            history: <><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></>,
            alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
            login: <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/>,
            lightning: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>,
            userX: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
            search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            list: <><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
            volume: <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>,
            volumeX: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></>,
            music: <path d="M9 18V5l12-2v13"></path>,
            skipBack: <><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></>,
            skipForward: <><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></>,
            print: <><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></>,
            lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        };

        const Icon = ({ path, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        // -- Music Player Component --
        const MusicPlayer = forwardRef((props, ref) => {
            const [playlist, setPlaylist] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [volume, setVolume] = useState(0.5);
            const [hasInteracted, setHasInteracted] = useState(false);
            const [status, setStatus] = useState('loading'); 
            const audioRef = useRef(null);

            useImperativeHandle(ref, () => ({
                triggerPlay: () => {
                    if (playlist.length === 0) return;
                    if (!hasInteracted) {
                        setHasInteracted(true);
                        if (audioRef.current) {
                            audioRef.current.play().then(() => setIsPlaying(true)).catch(e => console.log("Autoplay blocked", e));
                        }
                    } else if (!isPlaying) {
                        audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
                    }
                }
            }));

            useEffect(() => {
                const fetchMusic = async () => {
                    if (!MUSIC_CONFIG.username || !MUSIC_CONFIG.repo) { setStatus('error'); return; }
                    try {
                        setStatus('loading');
                        const url = `https://api.github.com/repos/${MUSIC_CONFIG.username}/${MUSIC_CONFIG.repo}/contents/${MUSIC_CONFIG.folder}`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('Network response was not ok');
                        const data = await res.json();
                        const tracks = data.filter(item => item.name.endsWith('.mp3')).map(item => ({ title: item.name.replace(/\.mp3$/i, ''), src: item.download_url }));
                        if (tracks.length > 0) {
                            for (let i = tracks.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [tracks[i], tracks[j]] = [tracks[j], tracks[i]];
                            }
                            setPlaylist(tracks); setStatus('ready');
                        } else { setStatus('empty'); }
                    } catch (error) { setStatus('error'); }
                };
                fetchMusic();
            }, []);

            useEffect(() => { if (audioRef.current) audioRef.current.volume = volume; }, [volume]);
            const handleEnded = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex + 1) % playlist.length); setIsPlaying(true); };
            const togglePlay = () => { if (!audioRef.current || playlist.length === 0) return; if (isPlaying) audioRef.current.pause(); else audioRef.current.play(); setIsPlaying(!isPlaying); };
            const playNext = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex + 1) % playlist.length); setIsPlaying(true); };
            const playPrev = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex - 1 + playlist.length) % playlist.length); setIsPlaying(true); };
            const currentTrack = playlist[currentIndex];
            const isReady = status === 'ready';
            const themeColor = '#FF8800';

            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-md px-5 py-2.5 rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-gray-100 flex items-center gap-4 transition-all duration-300 hover:shadow-[0_12px_40px_rgb(0,0,0,0.15)] no-print">
                    {isReady && <audio ref={audioRef} src={currentTrack.src} onEnded={handleEnded} autoPlay={isPlaying} />}
                    <div className="w-32 md:w-48 overflow-hidden relative h-6 flex items-center bg-orange-50 rounded-md px-2 border border-orange-100">
                        <div className={`absolute whitespace-nowrap font-bold text-sm ${isReady ? 'animate-marquee' : 'left-2'}`} style={{ color: themeColor }}>
                            {status === 'loading' ? "⏳ 讀取中..." : status === 'error' ? "⚠️ 設定錯誤" : status === 'empty' ? "⚠️ 無檔案" : `🎵 ${currentTrack.title} 🎵 ${currentTrack.title}`}
                        </div>
                    </div>
                    <div className={`flex items-center gap-3 ${!isReady ? 'opacity-50 pointer-events-none' : ''}`}>
                        <div className="flex items-center gap-1 group">
                            <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="hover:opacity-80 transition-opacity" style={{ color: themeColor }}><Icon path={volume === 0 ? icons.volumeX : icons.volume} className="w-4 h-4" /></button>
                            <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="w-16 volume-slider opacity-50 group-hover:opacity-100 transition-opacity" />
                        </div>
                        <div className="flex items-center gap-2 border-l border-gray-200 pl-3">
                            <button onClick={playPrev} className="hover:opacity-80 transition-transform active:scale-90" style={{ color: themeColor }}><Icon path={icons.skipBack} className="w-5 h-5" fill="currentColor"/></button>
                            <button onClick={togglePlay} className="rounded-full p-1.5 hover:opacity-90 transition-transform active:scale-95 shadow-md text-white" style={{ backgroundColor: themeColor }}><Icon path={isPlaying ? icons.pause : icons.play} className="w-5 h-5" fill="currentColor"/></button>
                            <button onClick={playNext} className="hover:opacity-80 transition-transform active:scale-90" style={{ color: themeColor }}><Icon path={icons.skipForward} className="w-5 h-5" fill="currentColor"/></button>
                        </div>
                    </div>
                </div>
            );
        });

        // -- New Component: PrintView --
        const PrintView = ({ items, onMenu }) => {
            const chunkSize = 20; // 配合關卡數，每頁20題
            const chunks = [];
            for (let i = 0; i < items.length; i += chunkSize) {
                chunks.push(items.slice(i, i + chunkSize));
            }

            return (
                <div id="print-area" className="w-full bg-white text-black">
                    {/* Control Bar (No Print) */}
                    <div className="fixed top-4 right-4 z-50 flex gap-2 no-print">
                        <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center">
                            <Icon path={icons.print} className="w-5 h-5 mr-2"/> 列印
                        </button>
                        <button onClick={onMenu} className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg">
                            返回
                        </button>
                    </div>

                    {chunks.map((chunk, pageIndex) => (
                        <div key={pageIndex} className="a4-page mx-auto bg-white mb-8 shadow-lg print:shadow-none print:mb-0 box-border flex flex-col">
                            {/* Header per page */}
                            <div className="text-center mb-6 border-b-2 border-black pb-2">
                                <h1 className="text-3xl font-bold font-serif tracking-widest">中文量詞大師 - 隨堂測驗 (卷{pageIndex + 1})</h1>
                                <div className="flex justify-between mt-4 text-base font-bold font-serif">
                                    <span>班級：__________ 姓名：__________ 座號：__________</span>
                                    <span>得分：__________</span>
                                </div>
                            </div>

                            {/* Questions Grid */}
                            <div className="grid grid-cols-2 gap-x-16 gap-y-6 flex-1 content-start">
                                {chunk.map((item, idx) => {
                                    const globalIndex = pageIndex * chunkSize + idx + 1;
                                    let content;
                                    
                                    // 判斷題目類型
                                    if (item.term.length > 2) {
                                        // 長量詞（較少見，預防萬一）
                                        content = (
                                            <div className="flex items-center gap-1">
                                                <span className="font-serif text-xl tracking-[0.2em] mr-2">{item.term}</span>
                                                <div className="border-b-2 border-black w-32"></div>
                                            </div>
                                        );
                                    } else {
                                        content = (
                                            <div className="flex items-center gap-1">
                                                <span className="font-serif text-xl font-bold mr-2 w-12 text-center border-r border-gray-400 pr-2">{item.term}</span>
                                                <span className="text-sm text-gray-500 mr-2 w-48 truncate">{item.definition.split('：')[0]}</span>
                                                <div className="border-b-2 border-black flex-1"></div>
                                            </div>
                                        );
                                    }

                                    return (
                                        <div key={item.id} className="flex items-center break-inside-avoid">
                                            <span className="mr-2 w-8 text-right font-mono text-lg font-bold">{globalIndex}.</span>
                                            {content}
                                        </div>
                                    )
                                })}
                            </div>
                            
                            <div className="mt-auto text-center text-xs text-gray-400 no-print">
                                * A4 直式排版，每頁 20 題。
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const MenuView = ({ 
            userName, setUserName, showNameWarning, mistakeLog, favorites, parsedData, 
            onStartLearn, onStartQuiz, onViewHistory, onViewMistakes, onViewTable, onPrint,
            onLogin, isLocked, onQuickLogin, globalUsers, onLogout, onDeleteUser,
            triggerMusic, connectionStatus, completedDays, onStartWaterfall 
        }) => {
            const totalPages = Math.ceil(parsedData["精選成語"].length / ITEMS_PER_PAGE);
            const progressPercent = totalPages > 0 ? Math.min(100, Math.round((completedDays.length / totalPages) * 100)) : 0;

            // 檢查某關卡是否完成的 helper
            const getLevelStatus = (levelIndex) => {
                const key = `精選成語-${levelIndex}`;
                const completedRecord = completedDays.find(item => item.id === key);
                return completedRecord ? { completed: true, date: completedRecord.date } : { completed: false };
            };

            return (
                <div className="max-w-6xl mx-auto px-4 py-8 animate-fade-in-up mt-16 no-print">
                    {/* Dashboard Header */}
                    <div className="bg-white/90 backdrop-blur-md rounded-3xl p-6 md:p-8 shadow-xl border border-amber-100 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <h1 className="text-4xl md:text-5xl font-extrabold text-amber-900 tracking-tight flex items-center gap-3 font-serif drop-shadow-sm mb-2">
                                <span className="text-5xl md:text-6xl filter drop-shadow-md">📜</span> 
<div className="flex items-center justify-center my-8 px-6">
  {/* 主標題 */}
  <h1 className="text-3xl md:text-5xl font-extrabold bg-gradient-to-r from-pink-500 via-amber-500 to-red-600 bg-clip-text text-transparent drop-shadow-lg animate-pulse pr-4">
    國文主題探索
  </h1>

  {/* 分隔線：漸層光束效果 */}
  <div className="flex items-center mx-6">
    <div className="h-1 w-24 bg-gradient-to-r from-pink-400 via-amber-300 to-red-400 animate-pulse rounded-full shadow-lg"></div>
    <span className="text-amber-500 text-xl animate-bounce">✨</span>
    <span className="text-amber-500 text-xl animate-bounce">✨</span>
    <span className="text-amber-500 text-xl animate-bounce">✨</span>

  </div>

  {/* 副標題 */}
  <div className="inline-flex items-center gap-2 px-4 py-2 bg-amber-100 border border-amber-400 rounded-full shadow-md hover:scale-105 transition-transform duration-300">
    <span className="text-sm md:text-lg font-semibold text-amber-700">
      單元10 中文量詞
    </span>
  </div>
</div>                            </h1>
                            <p className="text-gray-500 font-bold ml-2">互動式學習系統 v2.0</p>
                            
                            {/* 返回總部按鈕 */}
                            <div style={{ marginTop: '20px' }}>
                                <a href="index.html" 
                                   className="btn btn-gray hover:opacity-90 transition-opacity shadow-md hover:shadow-lg transform active:scale-95 transition-transform" 
                                   style={{
                                       textDecoration: 'none', 
                                       padding: '10px 20px',
                                       background: 'linear-gradient(135deg, #ff4081 0%, #d81b60 100%)',
                                       color: 'white', 
                                       borderRadius: '999px', 
                                       display: 'inline-block',
                                       fontWeight: 'bold'
                                   }}>
                                    🏠 返回成語學習 App 總部
                                </a>
                            </div>
                        </div>
                        
                        {/* 狀態指示燈 & 進度 */}
                        <div className="flex flex-col items-end gap-3 w-full md:w-auto">
                            <div className="flex items-center bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 shadow-inner text-sm font-bold text-gray-700">
                                <span className={`status-dot ${
                                    connectionStatus === 'loading' ? 'status-loading' : 
                                    connectionStatus === 'success' ? 'status-success' : 'status-error'
                                }`}></span>
                                {connectionStatus === 'loading' ? '雲端讀取中...' : 
                                 connectionStatus === 'success' ? '雲端已同步' : '雲端連線失敗'}
                            </div>
                            
                            {/* 總進度條 */}
                            {isLocked && (
                                <div className="w-full md:w-64 bg-white p-3 rounded-xl border border-amber-100 shadow-sm">
                                    <div className="flex justify-between text-xs font-bold text-amber-800 mb-1">
                                        <span>修煉總進度</span>
                                        <span>{progressPercent}% (卷 {completedDays.length}/{totalPages})</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div 
                                            className="bg-gradient-to-r from-amber-400 to-amber-600 h-3 rounded-full transition-all duration-1000 ease-out flex items-center justify-end" 
                                            style={{ width: `${progressPercent}%` }}
                                        >
                                            {progressPercent > 0 && <div className="w-full h-full animate-pulse bg-white/20"></div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* Left Column: User Profile & Login */}
                        <div className="lg:col-span-3 space-y-6">
                            <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-md border-2 border-amber-200 h-full flex flex-col">
                                <h3 className="text-xl font-black text-amber-900 mb-4 flex items-center border-b border-amber-100 pb-2">
                                    <Icon path={icons.login} className="w-6 h-6 mr-2"/> 挑戰者登入
                                </h3>
                                
                                <div className="flex-1 flex flex-col gap-4">
                                    <div className="relative">
                                        <label className="block text-sm font-bold text-gray-500 mb-1">主公姓名</label>
                                        <input 
                                            type="text" 
                                            value={userName}
                                            onChange={(e) => !isLocked && setUserName(e.target.value)}
                                            placeholder="請輸入姓名"
                                            disabled={isLocked}
                                            className={`w-full border-2 rounded-xl px-4 py-3 outline-none transition-all text-lg font-bold ${isLocked ? 'bg-green-50 text-green-800 border-green-200 cursor-not-allowed' : (showNameWarning ? 'border-red-500 bg-red-50 ring-2 ring-red-200 animate-shake' : 'border-amber-300 focus:ring-4 focus:ring-amber-200')}`}
                                        />
                                        {showNameWarning && <div className="text-xs text-red-500 font-bold mt-1 ml-1 animate-pulse">* 請先輸入姓名</div>}
                                    </div>

                                    {!isLocked ? (
                                        <button onClick={() => { onLogin(); triggerMusic(); }} className="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl text-lg font-bold shadow-md transform active:scale-95 transition-all flex justify-center items-center">
                                            <Icon path={icons.login} className="w-5 h-5 mr-2"/> 開始冒險
                                        </button>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-bold transition-colors flex justify-center items-center">
                                                <Icon path={icons.logout} className="w-4 h-4 mr-2"/> 登出
                                            </button>
                                            <button onClick={onDeleteUser} className="bg-red-50 hover:bg-red-100 text-red-600 py-3 rounded-xl font-bold transition-colors flex justify-center items-center" title="刪除使用者">
                                                <Icon path={icons.userX} className="w-4 h-4 mr-2"/> 刪除
                                            </button>
                                        </div>
                                    )}

                                    {/* 快速登入 */}
                                    {!isLocked && (
                                        <div className="mt-4 bg-amber-50 rounded-xl p-3 border border-amber-100 flex-1">
                                            <div className="text-xs text-amber-800 font-bold mb-2 flex items-center">
                                                <Icon path={icons.lightning} className="w-3 h-3 mr-1"/> 歷史挑戰者
                                            </div>
                                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto content-start">
                                                {globalUsers.length > 0 ? (
                                                    globalUsers.map((u, idx) => (
                                                        <button 
                                                            key={idx}
                                                            onClick={() => { onQuickLogin(u); triggerMusic(); }}
                                                            className="bg-white hover:bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-blue-100 shadow-sm transition-all hover:-translate-y-0.5"
                                                        >
                                                            {u}
                                                        </button>
                                                    ))
                                                ) : (
                                                    <div className="w-full text-center text-gray-400 text-xs py-4 italic">
                                                        尚無紀錄，歡迎加入！
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Main Content */}
                        <div className="lg:col-span-9 space-y-6">
                            {/* 修煉進度地圖 */}
                            <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-blue-100">
                                <h3 className="text-2xl font-black text-blue-900 mb-6 flex items-center">
                                    🗺️ 修煉進度地圖 <span className="ml-3 text-sm font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg">共 {totalPages} 關</span>
                                </h3>
                                <div className="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                        {Array.from({ length: totalPages }).map((_, i) => {
                                            const status = getLevelStatus(i);
                                            return (
                                                <button 
                                                    key={i}
                                                    onClick={() => { onStartQuiz('精選成語', i); triggerMusic(); }}
                                                    className={`relative p-4 rounded-xl border-2 flex flex-col items-center justify-center gap-2 transition-all h-32 group
                                                        ${status.completed 
                                                            ? 'bg-green-50 border-green-200 hover:border-green-400' 
                                                            : 'bg-white border-gray-200 hover:border-amber-400 hover:shadow-md'
                                                        }`}
                                                >
                                                    <div className={`text-lg font-black ${status.completed ? 'text-green-700' : 'text-gray-600'}`}>
                                                        卷 {i + 1}
                                                    </div>
                                                    {status.completed ? (
                                                        <div className="flex flex-col items-center">
                                                            <div className="bg-green-100 text-green-600 p-1 rounded-full mb-1">
                                                                <Icon path={icons.check} className="w-6 h-6"/>
                                                            </div>
                                                            <span className="text-sm font-mono text-green-600 font-bold bg-green-100/50 px-2 py-0.5 rounded">{status.date}</span>
                                                        </div>
                                                    ) : (
                                                        <div className="text-gray-300 group-hover:text-amber-400 transition-colors">
                                                            <Icon path={icons.lock} className="w-8 h-8"/>
                                                        </div>
                                                    )}
                                                    {!status.completed && (
                                                        <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                                                            <span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-amber-600 shadow-sm">挑戰</span>
                                                        </div>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>

                            {/* Main Cards (Learning & My Favorites & Waterfall) */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {/* 學習模式 */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-amber-100 hover:border-amber-300 transition-all group relative overflow-hidden cursor-pointer" onClick={() => { onStartLearn('精選成語'); triggerMusic(); }}>
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-amber-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <h3 className="text-2xl font-black text-amber-900 mb-2 relative z-10">📖 研讀量詞</h3>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">瀏覽所有量詞，學習釋義與應用範例。</p>
                                    <div className="flex gap-3 relative z-10">
                                        <button className="flex-1 bg-amber-100 hover:bg-amber-200 text-amber-800 py-3 rounded-xl font-bold transition-colors flex items-center justify-center">
                                            <Icon path={icons.book} className="w-5 h-5 mr-2"/> 開始研讀
                                        </button>
                                    </div>
                                </div>

                                {/* 我的收藏 */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-rose-100 hover:border-rose-300 transition-all group relative overflow-hidden">
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-rose-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="flex justify-between items-start relative z-10 mb-2">
                                        <h3 className="text-2xl font-black text-rose-900 flex items-center"><Icon path={icons.heart} className="w-6 h-6 mr-2 text-rose-500" fill="currentColor"/> 我的收藏</h3>
                                        <span className="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-full">{favorites.length}</span>
                                    </div>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">複習您收藏的重點量詞，隨時溫故知新。</p>
                                    <div className="flex gap-3 relative z-10">
                                        <button onClick={() => { onStartLearn('收藏夾'); triggerMusic(); }} disabled={favorites.length===0} className="flex-1 bg-rose-50 hover:bg-rose-100 text-rose-700 py-3 rounded-xl font-bold transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Icon path={icons.book} className="w-5 h-5 mr-2"/> 溫故
                                        </button>
                                        <button onClick={() => { onStartQuiz('收藏夾'); triggerMusic(); }} disabled={favorites.length===0} className="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-3 rounded-xl font-bold shadow-md transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Icon path={icons.play} className="w-5 h-5 mr-2"/> 知新
                                        </button>
                                    </div>
                                </div>

                                {/* 瀑布刷題 */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-cyan-100 hover:border-cyan-300 transition-all group relative overflow-hidden cursor-pointer" onClick={() => { onStartWaterfall(); triggerMusic(); }}>
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-cyan-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <h3 className="text-2xl font-black text-cyan-900 mb-2 relative z-10">🌊 瀑布刷題</h3>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">不分卷數，一次挑戰所有題目，極速複習。</p>
                                    <div className="flex gap-3 relative z-10">
                                        <button className="flex-1 bg-cyan-100 hover:bg-cyan-200 text-cyan-800 py-3 rounded-xl font-bold transition-colors flex items-center justify-center">
                                            <Icon path={icons.activity} className="w-5 h-5 mr-2"/> 立即開刷
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Secondary Actions Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onClick={onViewTable} className="bg-white/80 hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all group">
                                    <div className="bg-purple-100 text-purple-500 p-3 rounded-full mb-1 shadow-sm group-hover:scale-110 transition-transform"><Icon path={icons.list} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">量詞總覽</span>
                                </button>

                                <button onClick={onViewMistakes} className="bg-white/80 hover:bg-red-50 border-2 border-red-100 hover:border-red-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-red-100 text-red-500 p-3 rounded-full mb-1"><Icon path={icons.alert} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">錯題本</span>
                                    <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">{mistakeLog.length}</span>
                                </button>

                                <button onClick={onViewHistory} className="bg-white/80 hover:bg-blue-50 border-2 border-blue-100 hover:border-blue-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-blue-100 text-blue-500 p-3 rounded-full mb-1"><Icon path={icons.history} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">戰績表</span>
                                </button>

                                <button onClick={onPrint} className="bg-white/80 hover:bg-gray-50 border-2 border-gray-200 hover:border-gray-400 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-gray-100 text-gray-600 p-3 rounded-full mb-1"><Icon path={icons.print} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">列印考卷</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-12 text-center text-gray-500 text-sm font-medium bg-white/50 backdrop-blur rounded-full py-2 inline-block px-6 mx-auto w-full md:w-auto">
                        &copy; 2025 國文主題探索 • 互動式學習系統
                    </div>
                </div>
            );
        };

        const TableView = ({ items, onMenu, favorites, toggleFavorite }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const filteredItems = useMemo(() => {
                if (!searchTerm.trim()) return items;
                const lowerTerm = searchTerm.toLowerCase();
                return items.filter(item => String(item.id).includes(lowerTerm) || item.term.includes(lowerTerm) || item.definition.includes(lowerTerm) || item.sentence1.includes(lowerTerm));
            }, [items, searchTerm]);

            return (
                <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in-up mt-12 no-print">
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-xl overflow-hidden border border-gray-200 flex flex-col h-[85vh]">
                        <div className="p-6 border-b border-gray-200 bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <button onClick={onMenu} className="flex items-center text-gray-600 hover:text-gray-900 font-bold bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors shadow-sm"><Icon path={icons.left} className="w-5 h-5 mr-2"/> 返回</button>
                                <h2 className="text-2xl font-black text-gray-800 flex items-center"><Icon path={icons.list} className="w-6 h-6 mr-3 text-purple-600"/> 量詞一覽表 <span className="ml-3 text-sm font-normal text-gray-500 bg-gray-200 px-2 py-1 rounded-full">共 {items.length} 則</span></h2>
                            </div>
                            <div className="relative w-full md:w-96">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon path={icons.search} className="w-5 h-5"/></div>
                                <input type="text" placeholder="搜尋量詞、編號..." className="pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl w-full focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto bg-white p-0">
                            <table className="w-full text-left border-collapse prose-table">
                                <thead className="bg-purple-50 sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="p-2 text-center w-16 text-lg">收藏</th>
                                        <th className="p-2 text-center w-16 text-lg">編號</th>
                                        <th className="p-4 w-40 text-lg">量詞</th>
                                        <th className="p-4 text-lg">釋義/注音/範例</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredItems.map(item => (
                                        <tr key={item.id} className="hover:bg-purple-50/50 transition-colors">
                                            <td className="p-2 text-center">
                                                <button onClick={() => toggleFavorite(item.id)}>
                                                    <Icon path={icons.heart} className={`w-8 h-8 ${favorites.includes(item.id) ? "text-red-500" : "text-gray-300 hover:text-red-400"}`} fill={favorites.includes(item.id) ? "currentColor" : "none"} />
                                                </button>
                                            </td>
                                            <td className="p-2 text-center font-mono text-xl text-gray-500">{item.id}</td>
                                            <td className="p-4 font-black text-gray-900 text-3xl">{item.term}</td>
                                            <td className="p-4 text-gray-700 text-xl whitespace-pre-wrap leading-relaxed">{item.definition}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const LearnView = ({ items, learnPage, setLearnPage, favorites, toggleFavorite, completedDays, onMenu }) => {
            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            const currentItems = items.slice(learnPage * ITEMS_PER_PAGE, (learnPage + 1) * ITEMS_PER_PAGE);
            const scrollRef = useRef(null);
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = 0; window.scrollTo(0, 0); }, [learnPage]);

            return (
                <div className="max-w-4xl mx-auto px-4 py-6 mt-12 no-print" ref={scrollRef}>
                    <div className="bg-white/90 backdrop-blur-md p-4 rounded-xl shadow-sm mb-8 flex flex-col md:flex-row justify-between items-center sticky top-16 z-30 border-b-2 border-amber-200">
                        <div className="flex items-center gap-4 mb-4 md:mb-0 w-full md:w-auto">
                            <button onClick={onMenu} className="text-gray-500 hover:text-gray-900 flex items-center whitespace-nowrap bg-gray-100 px-3 py-2 rounded-lg font-bold"><Icon path={icons.menu} className="w-5 h-5 mr-2"/> 選單</button>
                            <h2 className="text-2xl font-black flex items-center whitespace-nowrap text-amber-900">📖 典故卷軸</h2>
                        </div>
                        <div className="flex overflow-x-auto overflow-y-hidden max-w-full w-full md:w-auto pb-2 md:pb-0 gap-2 mt-2 md:mt-0">
                            {Array.from({ length: totalPages }).map((_, i) => (<button key={i} onClick={() => setLearnPage(i)} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap flex items-center gap-2 transition-all flex-shrink-0 ${learnPage === i ? 'bg-amber-600 text-white shadow-md transform scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>卷 {i + 1} {completedDays.some(item => item.id === `精選成語-${i}`) && <span className="bg-green-400 text-white text-[10px] px-1.5 py-0.5 rounded-full">✓</span>}</button>))}
                        </div>
                    </div>
                    <div className="space-y-8">
                        {currentItems.map((item, idx) => (
                            <div key={item.id} className="bg-white/95 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-sm border border-amber-100 relative group hover:shadow-lg transition-all animate-fade-in-up" style={{animationDelay: `${idx * 0.05}s`}}>
                                <button onClick={() => toggleFavorite(item.id)} className="absolute top-6 right-6 text-gray-200 hover:text-red-500 z-10 transition-colors"><Icon path={icons.heart} className={`w-8 h-8 drop-shadow-sm ${favorites.includes(item.id) ? "text-red-500" : ""}`} fill={favorites.includes(item.id) ? "currentColor" : "none"} /></button>
                                <div className="flex flex-col md:flex-row gap-8">
                                    <div className="flex-1">
                                        <div className="flex items-baseline gap-3 mb-3 flex-wrap pr-10"><span className="text-amber-300 font-mono text-xl font-black">#{String(item.id).padStart(3,'0')}</span><h3 className="text-3xl font-black text-gray-900 tracking-tight">{item.term}</h3></div>
                                        <div className="bg-gradient-to-r from-amber-50 to-transparent p-4 rounded-xl text-amber-900 mb-6 text-lg font-medium border-l-8 border-amber-400 whitespace-pre-wrap">{item.definition}</div>
                                        <div className="text-gray-600 leading-relaxed pl-4 italic border-l-4 border-gray-300 text-lg bg-gray-50 py-2 pr-2 rounded-r-lg"><span className="font-bold not-italic text-gray-400 mr-2 text-sm">應用範例</span>{item.sentence1}</div>
                                    </div>
                                    {/* 移除圖片顯示區域 */}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="h-20"></div>
                </div>
            );
        };

        const QuizView = ({ questions, score, userName, combo, onAnswer, onFinish, onMenu, onViewHistory, favorites, toggleFavorite, totalItems, quizPage, onPageChange, completedDays, activeCategory }) => {
            const [showResult, setShowResult] = useState(false);
            const isFinished = questions.length > 0 && questions.every(q => q.userAnswer !== null);
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            useEffect(() => { if (isFinished && !showResult) { const timer = setTimeout(() => { onFinish(); setShowResult(true); }, 800); return () => clearTimeout(timer); } }, [isFinished]);

            if (showResult) {
                 return (
                    <div className="max-w-2xl mx-auto pt-10 px-4 animate-fade-in-up mt-12 no-print">
                        <div className="bg-white rounded-3xl shadow-2xl overflow-hidden text-center border-4 border-amber-400">
                            <div className="bg-amber-500 p-10 text-white relative overflow-hidden"><h2 className="text-4xl font-black mb-2 font-serif relative z-10">戰役結束</h2><p className="opacity-90 font-bold text-lg relative z-10">主公 {userName} 辛苦了</p></div>
                            <div className="p-10">
                                <div className="text-8xl font-black text-amber-600 mb-2 font-mono tracking-tighter">{score} <span className="text-3xl text-gray-300 font-bold">/ {questions.length}</span></div>
                                <div className="flex justify-center gap-4 mb-10"><div className="flex-1 bg-green-50 text-green-700 py-4 rounded-2xl font-black text-xl border-2 border-green-200">大捷 {score}</div><div className="flex-1 bg-red-50 text-red-700 py-4 rounded-2xl font-black text-xl border-2 border-red-200">失利 {questions.length - score}</div></div>
                                <div className="flex flex-col gap-4"><button onClick={onMenu} className="w-full py-4 bg-gray-100 hover:bg-gray-200 rounded-2xl font-black text-gray-700 text-xl transition-colors">返回大營</button><button onClick={onViewHistory} className="w-full py-4 bg-amber-600 hover:bg-amber-700 rounded-2xl font-black text-white shadow-xl shadow-amber-200 text-xl transition-all transform active:scale-95">查看詳細戰報</button></div>
                            </div>
                        </div>
                    </div>
                );
            }
            return (
                <div className="max-w-4xl mx-auto pb-20 px-4 mt-12 no-print">
                    <div className="bg-white/95 backdrop-blur shadow-sm p-4 rounded-b-2xl mb-8 sticky top-16 z-30 border-t-4 border-amber-500 flex flex-col md:flex-row justify-between items-center transition-all">
                        <div className="flex items-center gap-4 mb-4 md:mb-0 w-full md:w-auto justify-between md:justify-start"><button onClick={onMenu} className="text-gray-500 text-sm flex items-center hover:text-red-600 font-bold bg-gray-100 px-3 py-2 rounded-lg transition-colors"><Icon path={icons.left} className="w-4 h-4 mr-1"/> 撤退</button><div className="font-bold text-xl flex items-center gap-3"><span>{userName}</span><span className="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-black border border-amber-200">戰功: {score}</span></div></div>
                        
                        {/* 只有在非瀑布模式下顯示頁碼導覽 */}
                        {activeCategory !== 'waterfall' && (
                            <div className="flex overflow-x-auto overflow-y-hidden max-w-full w-full md:w-auto pb-1 md:pb-0 gap-2">
                                {Array.from({ length: totalPages }).map((_, i) => (<button key={i} onClick={() => onPageChange(i)} className={`px-3 py-1.5 rounded-md text-xs font-bold whitespace-nowrap flex items-center gap-1 transition-all flex-shrink-0 ${quizPage === i ? 'bg-amber-600 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>卷{i + 1}{completedDays.some(item => item.id === `精選成語-${i}`) && <span className="bg-green-400 text-white text-[10px] w-3 h-3 flex items-center justify-center rounded-full">✓</span>}</button>))}
                            </div>
                        )}
                        {activeCategory === 'waterfall' && (
                            <div className="text-cyan-600 font-bold text-sm bg-cyan-50 px-3 py-1 rounded-full border border-cyan-200 flex items-center">
                                <Icon path={icons.activity} className="w-4 h-4 mr-1"/> 瀑布模式：全題目挑戰
                            </div>
                        )}
                    </div>
                    <div className="space-y-8">
                        {questions.map((q, idx) => (
                            <div key={idx} className={`bg-white/95 backdrop-blur-sm rounded-3xl shadow-sm border-4 overflow-hidden transition-all duration-500 relative ${q.userAnswer === null ? 'border-transparent shadow-md' : (q.isCorrect ? 'border-green-200 bg-green-50/20' : 'border-red-200 bg-red-50/20')}`}>
                                <button onClick={() => toggleFavorite(q.id)} className="absolute top-5 right-5 z-10 transition-colors p-2 rounded-full bg-white/50 hover:bg-white"><Icon path={icons.heart} className={`w-7 h-7 ${favorites.includes(q.id) ? 'text-red-500' : 'text-gray-300'}`} fill={favorites.includes(q.id) ? "currentColor" : "none"} /></button>
                                <div className="p-8 border-b border-gray-100">
                                    <div className="flex justify-between items-center mb-6"><span className="font-black text-amber-900 tracking-wider text-sm bg-amber-100 px-3 py-1 rounded-full border border-amber-200">問題 {idx + 1}</span>{q.userAnswer !== null && (q.isCorrect ? <span className="text-green-600 font-black flex items-center text-lg animate-pop mr-12"><Icon path={icons.check} className="w-6 h-6 mr-1"/> 正確</span> : <span className="text-red-600 font-black flex items-center text-lg animate-shake mr-12"><Icon path={icons.alert} className="w-6 h-6 mr-1"/> 錯誤</span>)}</div>
                                    <div className="text-2xl md:text-3xl font-bold text-gray-800 leading-relaxed text-justify">
                                        {/* 填充題邏輯優化 */}
                                        {q.sentence2.split('____').map((part, i, arr) => (
                                            <span key={i}>
                                                {part}
                                                {i < arr.length - 1 && (
                                                    <span className="inline-block min-w-[100px] border-b-4 border-gray-400 mx-2 align-bottom text-center px-1 relative -top-1">
                                                        {q.userAnswer !== null && q.isCorrect ? 
                                                            <span className="text-amber-700 animate-pop inline-block">{q.term}</span> : 
                                                            <span className="opacity-0 select-none">{q.term}</span>
                                                        }
                                                        {q.userAnswer !== null && !q.isCorrect && (
                                                            <span className="absolute -top-8 left-0 w-full text-center text-sm text-green-600 font-bold whitespace-nowrap animate-bounce">
                                                                {q.term}
                                                            </span>
                                                        )}
                                                    </span>
                                                )}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-6 bg-gray-50/50"><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{q.options.map(opt => { let btnClass = "p-5 rounded-2xl border-2 text-left font-bold text-xl transition-all relative overflow-hidden "; if (q.userAnswer === null) btnClass += "bg-white border-gray-200 hover:border-amber-400 hover:shadow-md cursor-pointer active:scale-[0.98] text-gray-700"; else { if (opt.id === q.id) btnClass += "bg-green-100 border-green-500 text-green-800 ring-2 ring-green-200 shadow-md"; else if (opt.id === q.userAnswer) btnClass += "bg-red-100 border-red-500 text-red-800 opacity-80"; else btnClass += "bg-gray-50 border-gray-200 text-gray-300 opacity-40 grayscale"; } return (<button key={opt.id} onClick={() => onAnswer(idx, opt.id)} disabled={q.userAnswer !== null} className={btnClass}>{opt.term}{q.userAnswer !== null && opt.id === q.id && <div className="absolute right-4 top-1/2 -translate-y-1/2 text-green-600 bg-white rounded-full p-1"><Icon path={icons.check} className="w-5 h-5"/></div>}</button>)})}</div></div>
                                
                                {q.userAnswer !== null && !q.isCorrect && (
                                    <div className="p-6 bg-red-50/50 border-t border-red-100 animate-fade-in-up">
                                        <div className="bg-white rounded-xl p-5 border border-red-200 flex flex-col md:flex-row gap-5 items-start shadow-sm">
                                            {/* 移除圖片顯示 */}
                                            <div className="flex-1">
                                                <div className="text-sm font-black text-red-800 mb-1 flex items-center gap-2 uppercase tracking-wide">
                                                    <Icon path={icons.book} className="w-4 h-4"/> 量詞釋義
                                                </div>
                                                <div className="flex items-center gap-2 mb-2">
                                                    <div className="text-2xl font-black text-gray-900">{q.term}</div>
                                                </div>
                                                <div className="text-gray-700 text-base leading-relaxed whitespace-pre-wrap">{q.definition}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HistoryView = ({ historyLog, setHistoryLog, onMenu }) => {
            const [selectedLog, setSelectedLog] = useState(null);
            if (selectedLog) {
                return (
                    <div className="w-full max-w-4xl mx-auto bg-white/95 backdrop-blur-md min-h-screen p-6 md:p-8 shadow-2xl animate-fade-in-up mt-12 no-print">
                        <div className="flex justify-between items-center mb-8 pb-4 border-b border-gray-200 sticky top-16 bg-white z-20 pt-4"><button onClick={() => setSelectedLog(null)} className="flex items-center text-gray-500 hover:text-amber-800 font-bold text-lg px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors"><Icon path={icons.left} className="w-6 h-6 mr-1"/> 返回</button><div className="text-right"><h2 className="text-2xl font-black text-gray-800">戰役回放</h2><p className="text-gray-500 text-sm mt-1 font-mono">{selectedLog.date}</p></div></div>
                        <div className="space-y-6"><div className="flex justify-center mb-8"><div className="text-center"><div className="text-sm text-gray-400 font-bold uppercase mb-1">總得分</div><div className="text-5xl font-black text-amber-600">{selectedLog.score} <span className="text-2xl text-gray-300">/ {selectedLog.total}</span></div></div></div>{selectedLog.details.map((d, i) => (<div key={i} className={`p-6 rounded-2xl border-l-8 shadow-sm ${d.isCorrect ? 'border-green-400 bg-green-50/30' : 'border-red-400 bg-red-50/30'}`}><div className="mb-3 font-bold text-gray-800 text-xl leading-relaxed">{d.sentence}</div><div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-6 bg-white/50 p-3 rounded-lg"><div className="flex items-center"><span className="text-gray-400 text-xs font-bold uppercase mr-2">您的選擇</span><span className={`text-lg font-bold ${d.isCorrect ? "text-green-700" : "text-red-600 line-through decoration-2"}`}>{d.userAnswer}</span></div>{!d.isCorrect && (<div className="flex items-center"><span className="text-gray-400 text-xs font-bold uppercase mr-2">正解</span><span className="text-green-700 text-lg font-black">{d.correctAnswer}</span></div>)}</div></div>))}</div>
                        <div className="h-20"></div>
                    </div>
                )
            }
            return (
                <div className="max-w-4xl mx-auto px-4 py-8 mt-12 no-print">
                    <div className="flex items-center mb-8"><button onClick={onMenu} className="mr-4 p-3 bg-white rounded-xl shadow border border-gray-200 hover:bg-gray-50"><Icon path={icons.left} className="w-5 h-5"/></button><h2 className="text-3xl font-black text-gray-800 flex items-center gap-3">📜 歷史戰績 <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{historyLog.length} 場</span></h2></div>
                    {historyLog.length === 0 ? <div className="text-center py-32 text-gray-400 border-2 border-dashed border-gray-200 rounded-3xl bg-white/80 backdrop-blur"><Icon path={icons.history} className="w-16 h-16 mx-auto mb-4 text-gray-300"/><p className="text-xl font-bold">尚無戰役紀錄</p></div> : <div className="bg-white/95 backdrop-blur-md rounded-3xl shadow-lg overflow-hidden border border-gray-200"><table className="w-full text-left border-collapse"><thead className="bg-amber-50 border-b border-amber-100"><tr><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider hidden md:table-cell">日期</th><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider">主公</th><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider">戰功</th><th className="p-5 text-right">操作</th></tr></thead><tbody className="divide-y divide-gray-100">{historyLog.map(log => (<tr key={log.id} className="hover:bg-amber-50/50 transition-colors"><td className="p-5 text-gray-500 text-sm font-mono hidden md:table-cell">{log.date.split(',')[0]}</td><td className="p-5 font-bold text-gray-800">{log.userName}</td><td className="p-5"><span className="font-black px-3 py-1 rounded-lg text-sm bg-gray-100 text-gray-700 border border-gray-200">{log.score} <span className="text-gray-400 font-normal">/ {log.total}</span></span></td><td className="p-5 text-right"><button onClick={() => setSelectedLog(log)} className="text-amber-600 hover:text-white hover:bg-amber-600 px-4 py-2 rounded-lg text-sm font-bold transition-all border border-amber-200 hover:border-amber-600">查看</button></td></tr>))}</tbody></table></div>}
                    <div className="text-center mt-12 pb-10"><button onClick={() => {if(confirm('確定焚毀所有戰報？此操作無法復原！')) setHistoryLog([])}} className="text-red-400 hover:text-red-600 text-sm flex items-center justify-center mx-auto hover:bg-red-50/80 px-4 py-2 rounded-lg transition-colors"><Icon path={icons.trash} className="w-4 h-4 mr-2"/> 清除所有紀錄</button></div>
                </div>
            );
        };

        const App = () => {
            const parsedData = useMemo(() => ({ "精選成語": IDIOM_DATA }), []);
            const allItems = IDIOM_DATA;
            const [currentMode, setCurrentMode] = useState('menu'); 
            const [activeCategory, setActiveCategory] = useState(null);
            const [showNameWarning, setShowNameWarning] = useState(false);
            const [userName, setUserName] = useState('');
            const [isLocked, setIsLocked] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('loading'); 
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [globalUsers, setGlobalUsers] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [historyLog, setHistoryLog] = useState([]);
            const [mistakeLog, setMistakeLog] = useState([]);
            const [completedDays, setCompletedDays] = useState([]); 
            const [savedSession, setSavedSession] = useState(null);
            const [learnPage, setLearnPage] = useState(0);
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [quizScore, setQuizScore] = useState(0);
            const [combo, setCombo] = useState(0);
            const [quizPage, setQuizPage] = useState(0);
            const [lastUser, setLastUser] = useState(null);
            const musicPlayerRef = useRef(null);

            const triggerMusic = () => { if(musicPlayerRef.current) musicPlayerRef.current.triggerPlay(); };

            useEffect(() => {
                if (!isFirebaseInitialized) { setConnectionStatus('error'); return; }
                const initAuth = async () => {
                    try {
                        setConnectionStatus('loading');
                        await signInAnonymously(auth);
                        setIsFirebaseReady(true);
                        setConnectionStatus('success');
                        const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                        const unsubscribeGlobal = onSnapshot(globalDocRef, (docSnap) => {
                            if (docSnap.exists()) { setGlobalUsers(docSnap.data().users || []); } 
                            else { setDoc(globalDocRef, { users: [] }, { merge: true }); }
                        }, () => setConnectionStatus('error'));
                        return unsubscribeGlobal;
                    } catch (error) { setConnectionStatus('error'); setIsFirebaseReady(false); }
                };
                const unsub = initAuth();
                return () => { if(typeof unsub === 'function') unsub(); };
            }, []);

            useEffect(() => {
                if (!isFirebaseReady || !userName || !isLocked) return;
                const userDocRef = doc(db, COLLECTION_NAME, userName);
                const unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setFavorites(data.favorites || []);
                        setHistoryLog(data.history || []);
                        setMistakeLog(data.mistakes || []);
                        
                        const loadedProgress = data.progress || [];
                        const formattedProgress = loadedProgress.map(item => {
                            if (typeof item === 'string') {
                                return { id: item, date: '舊紀錄', score: 0 };
                            }
                            return item;
                        });
                        setCompletedDays(formattedProgress);
                        
                        setSavedSession(data.currentQuizSession || null);
                        setConnectionStatus('success');
                    } else {
                        setDoc(userDocRef, { favorites: [], history: [], mistakes: [], progress: [], lastLogin: new Date().toISOString() }, { merge: true });
                    }
                }, () => setConnectionStatus('error'));
                return () => unsubscribeUser();
            }, [isFirebaseReady, userName, isLocked]);

            const updateUserData = async (field, value) => {
                if (!isFirebaseReady || !userName || !isLocked) return;
                try {
                    const userDocRef = doc(db, COLLECTION_NAME, userName);
                    await updateDoc(userDocRef, { [field]: value, lastUpdate: new Date().toISOString() });
                } catch (error) { console.error(`Error updating ${field}:`, error); setConnectionStatus('error'); }
            };

            const handleLogin = async () => { if (userName.trim()) { setIsLocked(true); setShowNameWarning(false); if (isFirebaseReady) { try { const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL); await updateDoc(globalDocRef, { users: arrayUnion(userName) }); } catch (e) {} } } else { setShowNameWarning(true); } };
            const handleQuickLogin = (name) => { setUserName(name); setIsLocked(true); setShowNameWarning(false); };
            const handleLogout = () => { if(confirm('確定要登出嗎？')) { setIsLocked(false); setUserName(''); setFavorites([]); setHistoryLog([]); setMistakeLog([]); setCompletedDays([]); setSavedSession(null); } };
            const handleDeleteUser = async () => { if (!isFirebaseReady) { alert("請先連線至雲端"); return; } if (confirm('【危險操作】確定要刪除這位使用者的所有資料嗎？')) { if (confirm('再次確認：這將會清除所有學習紀錄、收藏和錯題本，且無法復原！確定要執行嗎？')) { try { const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL); await updateDoc(globalDocRef, { users: arrayRemove(userName) }); const userDocRef = doc(db, COLLECTION_NAME, userName); await setDoc(userDocRef, { deleted: true }); setFavorites([]); setHistoryLog([]); setMistakeLog([]); setCompletedDays([]); setSavedSession(null); setIsLocked(false); setUserName(''); } catch (e) { alert("刪除失敗"); } } } };
            const toggleFavorite = (id) => { const newFavorites = favorites.includes(id) ? favorites.filter(fid => fid !== id) : [...favorites, id]; setFavorites(newFavorites); updateUserData('favorites', newFavorites); };
            const clearHistoryLog = () => { setHistoryLog([]); updateUserData('history', []); };
            const clearMistakeLog = () => { setMistakeLog([]); updateUserData('mistakes', []); };

            const playSoundEffect = (type) => { try { const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext(); const now = ctx.currentTime; if (type === 'correct') { const osc1 = ctx.createOscillator(); const gain1 = ctx.createGain(); osc1.type = 'sine'; osc1.frequency.setValueAtTime(523.25, now); gain1.gain.setValueAtTime(0.1, now); gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.5); osc1.connect(gain1); gain1.connect(ctx.destination); osc1.start(now); osc1.stop(now + 0.5); const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.type = 'sine'; osc2.frequency.setValueAtTime(659.25, now + 0.1); gain2.gain.setValueAtTime(0.1, now + 0.1); gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.6); osc2.connect(gain2); gain2.connect(ctx.destination); osc2.start(now + 0.1); osc2.stop(now + 0.6); } else { const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.connect(gain); gain.connect(ctx.destination); osc.start(now); osc.stop(now + 0.3); } } catch (e) {} };

            // Waterfall Mode Handler
            const handleStartWaterfall = () => {
                if (!isLocked) { setShowNameWarning(true); return; }
                
                // Check for saved session and load DIRECTLY (no confirm)
                if (savedSession && savedSession.category === 'waterfall') {
                    setQuizQuestions(savedSession.questions);
                    setQuizScore(savedSession.score);
                    setCombo(savedSession.combo);
                    setQuizPage(0);
                    setActiveCategory('waterfall');
                    setCurrentMode('quiz');
                    window.scrollTo(0, 0);
                    return;
                }

                // If not resuming or no session, clear any existing session (e.g. from other modes) and start new
                updateUserData('currentQuizSession', null); 

                let questions = [...allItems]; 
                questions.sort(() => Math.random() - 0.5);
                
                const quizSet = questions.map(item => { 
                    let pool = allItems.filter(i => i.id !== item.id); 
                    const distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3); 
                    const options = [...distractors, item].sort(() => Math.random() - 0.5); 
                    return { ...item, options, userAnswer: null, isCorrect: null }; 
                });
                
                setQuizQuestions(quizSet);
                setQuizScore(0);
                setCombo(0);
                setQuizPage(0);
                setActiveCategory('waterfall');
                setCurrentMode('quiz');
                window.scrollTo(0, 0);
            };

            const handleStartQuiz = (category, pageIdx = 0, isMistakeMode = false) => {
                if (!isLocked) { setShowNameWarning(true); return; }
                
                // Auto-resume if saved session matches the requested category and page (DIRECTLY LOAD)
                if (savedSession && savedSession.category === category && savedSession.pageIdx === pageIdx && !isMistakeMode) { 
                    setQuizQuestions(savedSession.questions); 
                    setQuizScore(savedSession.score); 
                    setCombo(savedSession.combo); 
                    setQuizPage(savedSession.pageIdx); 
                    setActiveCategory(savedSession.category); 
                    setCurrentMode('quiz'); 
                    return; 
                }

                let questions = [];
                if (isMistakeMode) { const mistakeIds = mistakeLog.map(m => m.id); questions = allItems.filter(i => mistakeIds.includes(i.id)); questions.sort(() => Math.random() - 0.5); } 
                else { 
                    let sourceItems = category === '收藏夾' ? allItems.filter(i => favorites.includes(i.id)) : parsedData["精選成語"]; 
                    if (!sourceItems || sourceItems.length === 0) { alert("此分類尚無內容！"); return; } 
                    const start = pageIdx * ITEMS_PER_PAGE; 
                    if (start >= sourceItems.length && pageIdx > 0) { handleStartQuiz(category, Math.floor((sourceItems.length - 1) / ITEMS_PER_PAGE), isMistakeMode); return; } 
                    questions = sourceItems.slice(start, start + ITEMS_PER_PAGE); 
                }
                if (questions.length === 0) { alert(isMistakeMode ? "目前沒有錯題！" : "此頁面無題目"); return; }
                const quizSet = questions.map(item => { let pool = allItems.filter(i => i.id !== item.id); const distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3); const options = [...distractors, item].sort(() => Math.random() - 0.5); return { ...item, options, userAnswer: null, isCorrect: null }; });
                setQuizQuestions(quizSet); setQuizScore(0); setCombo(0); setQuizPage(pageIdx); setActiveCategory(isMistakeMode ? '錯題本' : category); setCurrentMode('quiz'); window.scrollTo(0,0);
            };

            const handleAnswer = (qIndex, selectedOptionId) => {
                const newQuestions = [...quizQuestions];
                const q = newQuestions[qIndex];
                if (q.userAnswer !== null) return; 
                
                const isCorrect = selectedOptionId === q.id;
                q.userAnswer = selectedOptionId;
                q.isCorrect = isCorrect;
                
                let newScore = quizScore;
                let newCombo = combo;

                if (isCorrect) {
                    newScore = quizScore + 1;
                    newCombo = combo + 1;
                    setQuizScore(newScore);
                    setCombo(newCombo);
                    playSoundEffect('correct');
                    
                    if (newCombo > 0 && newCombo % 5 === 0) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    } else {
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, scalar: 0.7 });
                    }
                } else {
                    newCombo = 0;
                    setCombo(0);
                    playSoundEffect('wrong');
                    const newMistakeLog = [...mistakeLog];
                    const existingIndex = newMistakeLog.findIndex(m => m.id === q.id);
                    if (existingIndex > -1) { 
                        newMistakeLog[existingIndex] = { ...newMistakeLog[existingIndex], count: newMistakeLog[existingIndex].count + 1, lastMissed: new Date().toISOString() }; 
                    } else { 
                        newMistakeLog.push({ id: q.id, count: 1, lastMissed: new Date().toISOString() }); 
                    }
                    setMistakeLog(newMistakeLog);
                    updateUserData('mistakes', newMistakeLog);
                }
                setQuizQuestions(newQuestions);
                
                if (activeCategory !== '錯題本') {
                    updateUserData('currentQuizSession', {
                        questions: newQuestions,
                        score: newScore,
                        combo: newCombo,
                        category: activeCategory,
                        pageIdx: quizPage,
                        timestamp: new Date().toISOString()
                    });
                }
            };

            const finishQuiz = () => {
                const record = { id: Date.now(), date: new Date().toLocaleString(), userName, score: quizScore, total: quizQuestions.length, category: activeCategory, details: quizQuestions.map(q => ({ term: q.term, definition: q.definition, sentence: q.sentence2, isCorrect: q.isCorrect, userAnswer: q.options.find(o => o.id === q.userAnswer)?.term || "未作答", correctAnswer: q.term })) };
                const newHistory = [record, ...historyLog]; setHistoryLog(newHistory); updateUserData('history', newHistory);
                
                if (activeCategory !== '收藏夾' && activeCategory !== '錯題本' && activeCategory !== 'waterfall') { 
                    const key = `${activeCategory}-${quizPage}`; 
                    if (quizScore > 0) { 
                        const todayStr = new Date().toLocaleDateString();
                        const existingEntryIndex = completedDays.findIndex(item => item.id === key);
                        let newCompleted;
                        
                        if (existingEntryIndex >= 0) {
                            newCompleted = [...completedDays];
                            newCompleted[existingEntryIndex] = { ...newCompleted[existingEntryIndex], score: Math.max(newCompleted[existingEntryIndex].score || 0, quizScore), date: todayStr };
                        } else {
                            newCompleted = [...completedDays, { id: key, date: todayStr, score: quizScore }];
                        }
                        
                        setCompletedDays(newCompleted); 
                        updateUserData('progress', newCompleted); 
                    } 
                }
                updateUserData('currentQuizSession', null);
            };

            return (
                <div className="min-h-screen font-sans selection:bg-amber-200 selection:text-amber-900 relative">
                    {/* 背景色 */}
                    <div className="fixed inset-0 z-0 bg-cover bg-center transition-all duration-1000 no-print" style={{ backgroundColor: '#fcf9f2' }}></div>
                    <div className="fixed inset-0 z-0 bg-white/70 backdrop-blur-[2px] no-print"></div>
                    <div className="relative z-10">
                        <MusicPlayer ref={musicPlayerRef} />
                        {currentMode === 'menu' && <MenuView userName={userName} setUserName={setUserName} showNameWarning={showNameWarning} mistakeLog={mistakeLog} favorites={favorites} parsedData={parsedData} onStartLearn={(cat) => { setActiveCategory(cat); setLearnPage(0); setCurrentMode('learn'); }} onStartQuiz={(cat, page = 0) => handleStartQuiz(cat, page)} onViewHistory={() => setCurrentMode('history')} onViewMistakes={() => setCurrentMode('mistakes')} onViewTable={() => setCurrentMode('table')} onPrint={() => setCurrentMode('print')} onLogin={handleLogin} isLocked={isLocked} onQuickLogin={handleQuickLogin} lastUser={lastUser} onLogout={handleLogout} onDeleteUser={handleDeleteUser} globalUsers={globalUsers} triggerMusic={triggerMusic} connectionStatus={connectionStatus} completedDays={completedDays} onStartWaterfall={handleStartWaterfall} />}
                        {currentMode === 'learn' && <LearnView items={activeCategory === '收藏夾' ? allItems.filter(i => favorites.includes(i.id)) : parsedData["精選成語"]} learnPage={learnPage} setLearnPage={setLearnPage} favorites={favorites} toggleFavorite={toggleFavorite} completedDays={completedDays} onMenu={() => setCurrentMode('menu')} />}
                        {currentMode === 'quiz' && <QuizView questions={quizQuestions} score={quizScore} userName={userName} combo={combo} onAnswer={handleAnswer} onFinish={finishQuiz} onMenu={() => setCurrentMode('menu')} onViewHistory={() => setCurrentMode('history')} favorites={favorites} toggleFavorite={toggleFavorite} activeCategory={activeCategory} totalItems={activeCategory === '收藏夾' ? favorites.length : parsedData["精選成語"].length} quizPage={quizPage} onPageChange={(page) => handleStartQuiz(activeCategory, page)} completedDays={completedDays} activeCategory={activeCategory} />}
                        {currentMode === 'history' && <HistoryView historyLog={historyLog} setHistoryLog={clearHistoryLog} onMenu={() => setCurrentMode('menu')} />}
                        {currentMode === 'mistakes' && <MistakeView mistakes={allItems.filter(i => mistakeLog.some(m => m.id === i.id))} mistakeLog={mistakeLog} setMistakeLog={clearMistakeLog} onMenu={() => setCurrentMode('menu')} onReviewAll={() => handleStartQuiz(null, 0, true)} />}
                        {currentMode === 'table' && <TableView items={allItems} onMenu={() => setCurrentMode('menu')} favorites={favorites} toggleFavorite={toggleFavorite} />}
                        {currentMode === 'print' && <PrintView items={allItems} onMenu={() => setCurrentMode('menu')} />}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>