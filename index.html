<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹æ–‡å­¸ç¿’ App - é›²ç«¯é€²åŒ–ç‰ˆ</title>
    
    <!-- å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS (ç”¨æ–¼å¿«é€Ÿä½ˆå±€) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD Global) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for Firebase (Only for Firebase modules) -->
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        :root {
            /* åœ‹æ–‡ä¸»é¡Œé…è‰² */
            --bg: #f9f7f2;
            --text-main: #2c2c2c;
            --card-bg: #ffffff;
            --primary-amber: #ffab00;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* æ¨™é¡Œå­—é«” */
        .font-serif { font-family: 'Noto Serif TC', serif; }

        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .app-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-top: 6px solid #ccc;
            border-left: 1px solid rgba(0,0,0,0.05);
            border-right: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
        }

        /* === å·²å®Œæˆç‰¹æ•ˆ === */
        .app-card.completed {
            border: 4px solid var(--primary-amber) !important;
            border-top: 6px solid var(--primary-amber) !important;
            box-shadow: 0 0 20px rgba(255, 171, 0, 0.5) !important;
            transform: scale(1.02);
            background-color: #fff8e1;
            z-index: 10;
        }

        .app-card.completed .card-badge {
            background: var(--primary-amber) !important;
            box-shadow: 0 0 8px rgba(255, 171, 0, 0.6);
            color: #fff;
        }

        .app-card.completed .card-icon {
            background: rgba(255, 171, 0, 0.1) !important;
            color: #e65100 !important;
        }

        /* åœ–ç¤ºå®¹å™¨ */
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 15px;
            border: 1px solid transparent;
        }

        /* åˆ†éš”ç·š */
        .divider {
            display: flex;
            align-items: center;
            margin: 40px 0 20px 0;
            color: #555;
            font-family: 'Noto Serif TC', serif;
            font-size: 1.5em;
            font-weight: bold;
        }
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 2px solid #ddd;
        }
        .divider::before { margin-right: 15px; }
        .divider::after { margin-left: 15px; }

        /* ç‹€æ…‹ç‡ˆè™Ÿå‹•ç•« */
        @keyframes pulse-dot {
            0% { opacity: 0.6; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.6; transform: scale(0.9); }
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-loading { background-color: #fdd835; animation: pulse-dot 1.5s infinite; }
        .status-success { background-color: #4caf50; }
        .status-error { background-color: #ef5350; }
        .status-offline { background-color: #9e9e9e; }

        /* ä¸»é¡Œè‰²ç³»å®šç¾© */
        .theme-blue { --theme-c: #3949ab; --theme-bg: #e8eaf6; }
        .theme-orange { --theme-c: #e65100; --theme-bg: #fff3e0; }
        .theme-green { --theme-c: #2e7d32; --theme-bg: #e8f5e9; }
        .theme-teal { --theme-c: #00695c; --theme-bg: #e0f2f1; }
        .theme-purple { --theme-c: #6a1b9a; --theme-bg: #f3e5f5; }
        .theme-red { --theme-c: #c62828; --theme-bg: #ffebee; }
        .theme-brown { --theme-c: #8d6e63; --theme-bg: #efebe9; }
        .theme-indigo { --theme-c: #283593; --theme-bg: #e8eaf6; }

        .theme-item { border-top-color: var(--theme-c); }
        .theme-item .card-icon { background: var(--theme-bg); color: var(--theme-c); }
        .theme-item .card-title { color: var(--theme-c); }

        /* æ ¸å–æ–¹å¡Šæ¨£å¼ */
        .check-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: white;
        }
        .app-card:hover .check-circle { border-color: #bbb; }
        .app-card.completed .check-circle {
            background: var(--primary-amber);
            border-color: var(--primary-amber);
            color: white;
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "firebase/auth";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, arrayUnion } from "firebase/firestore";
        
        // â˜… ä¿®æ­£é‡é»ï¼šå› ç‚ºä½¿ç”¨ CDN UMD ç‰ˆæœ¬ï¼ŒReact å·²ç¶“æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œä¸éœ€è¦ importï¼Œç›´æ¥è§£æ§‹ä½¿ç”¨å³å¯ã€‚
        const { useState, useEffect, useMemo } = React;
        // ReactDOM ä¹Ÿæ˜¯å…¨åŸŸè®Šæ•¸

        /* ================= è³‡æ–™å®šç¾© ================= */
        const ALL_CATEGORIES = [
            {
                title: "èªè­˜å­—å½¢",
                theme: "theme-blue",
                items: [
                    { id: "L1", title: "ç¬¬ 1 ç«™", subtitle: "ã€Œç›¸ä¼¼è©èªã€çš„åˆ†è¾¨", file: "Chinese-Learning-1.html", icon: "âœï¸" },
                    { id: "L2", title: "ç¬¬ 2 ç«™", subtitle: "ã€Œå½¢è¿‘å­—ã€çš„åˆ†è¾¨", file: "Chinese-Learning-2.html", icon: "ğŸ‘€" },
                    { id: "L3", title: "ç¬¬ 3 ç«™", subtitle: "ã€ŒéŸ³è¿‘å­—ã€çš„åˆ†è¾¨", file: "Chinese-Learning-3.html", icon: "ğŸ”" },
                    { id: "L4", title: "ç¬¬ 4 ç«™", subtitle: "é‡è¦è©èªè¾¨æ­£", file: "Chinese-Learning-4.html", icon: "âœ…" }
                ]
            },
            {
                title: "åˆ†è¾¨å­—éŸ³",
                theme: "theme-orange",
                items: [
                    { id: "L5", title: "ç¬¬ 1 ç«™", subtitle: "ç›¸ä¼¼å­—ã€Œå­—éŸ³ã€è¾¨æ­£", file: "Chinese-Learning-5.html", icon: "ğŸ‘‚" },
                    { id: "L6", title: "ç¬¬ 2 ç«™", subtitle: "ä¸€å­—å¤šéŸ³è¾¨æ­£", file: "Chinese-Learning-6.html", icon: "ğŸ—£ï¸" },
                    { id: "L7", title: "ç¬¬ 3 ç«™", subtitle: "é‡è¦è®€éŸ³è¾¨æ­£", file: "Chinese-Learning-7.html", icon: "ğŸ”Š" }
                ]
            },
            {
                title: "æ¬£è³é€ å­—æ³•å‰‡",
                theme: "theme-green",
                items: [
                    { id: "L8", title: "ç¬¬ 1 ç«™", subtitle: "é€ å­—æ³•å‰‡", file: "Chinese-Learning-8.html", icon: "ğŸ§±" },
                    { id: "L9", title: "ç¬¬ 2 ç«™", subtitle: "æ¼¢å­—å½¢é«”çš„æ¼”è®Š", file: "Chinese-Learning-9.html", icon: "ğŸ“œ" }
                ]
            },
            {
                title: "åˆ¤åˆ¥å­—ç¾©",
                theme: "theme-teal",
                items: [
                    { id: "L10", title: "ç¬¬ 1 ç«™", subtitle: "é‡è©", file: "Chinese-Learning-10.html", icon: "ğŸ“" },
                    { id: "L11", title: "ç¬¬ 2 ç«™", subtitle: "å¯¦æ•¸ã€è™›æ•¸", file: "Chinese-Learning-11.html", icon: "ğŸ”¢" },
                    { id: "L12", title: "ç¬¬ 3 ç«™", subtitle: "é‡è¦å­—ç¾©ã€ä¸€å­—å¤šç¾©", file: "Chinese-Learning-12.html", icon: "ğŸ“–" },
                    { id: "L13", title: "ç¬¬ 4 ç«™", subtitle: "å…¶ä»–ç‰¹æ®Šå­—ç¾©", file: "Chinese-Learning-13.html", icon: "ğŸ’¡" }
                ]
            },
            {
                title: "ç†è§£è©èª",
                theme: "theme-purple",
                items: [
                    { id: "L14", title: "ç¬¬ 1 ç«™", subtitle: "ç‹€è²è©", file: "Chinese-Learning-14.html", icon: "ğŸ””" },
                    { id: "L15", title: "ç¬¬ 2 ç«™", subtitle: "æ•¬è©ã€è¬™è©", file: "Chinese-Learning-15.html", icon: "ğŸ™" },
                    { id: "L16", title: "ç¬¬ 3 ç«™", subtitle: "æ…£ç”¨èª", file: "Chinese-Learning-16.html", icon: "ğŸ’¬" },
                    { id: "L17", title: "ç¬¬ 4 ç«™", subtitle: "ä¸€è©å¤šç¾©", file: "Chinese-Learning-17.html", icon: "ğŸ”„" },
                    { id: "L18", title: "ç¬¬ 5 ç«™", subtitle: "å®¹æ˜“æ··æ·†çš„è©èª", file: "Chinese-Learning-18.html", icon: "ğŸ˜µ" },
                    { id: "L19", title: "ç¬¬ 6 ç«™", subtitle: "åç¾©è¤‡è©", file: "Chinese-Learning-19.html", icon: "âš–ï¸" },
                    { id: "L20", title: "ç¬¬ 7 ç«™", subtitle: "ä¸€èˆ¬å¸¸ç”¨è©èª", file: "Chinese-Learning-20.html", icon: "ğŸ“" }
                ]
            },
            {
                title: "æ´»ç”¨æˆèª",
                theme: "theme-orange",
                items: [
                    { id: "L21", title: "ç¬¬ 1 ç«™", subtitle: "å®¹æ˜“æ··æ·†çš„æˆèª", file: "Chinese-Learning-21.html", icon: "ğŸ‰" },
                    { id: "L22", title: "ç¬¬ 2 ç«™", subtitle: "æˆèªä¸­çš„åäºº", file: "Chinese-Learning-22.html", icon: "ğŸ§‘â€ğŸ«" },
                    { id: "L23", title: "ç¬¬ 3 ç«™", subtitle: "è²¶ç¾©æˆèª", file: "Chinese-Learning-23.html", icon: "ğŸ“‰" },
                    { id: "L24", title: "ç¬¬ 4 ç«™", subtitle: "ç¾©è¿‘æˆèª", file: "Chinese-Learning-24.html", icon: "ğŸ¤" },
                    { id: "L25", title: "ç¬¬ 5 ç«™", subtitle: "æˆèªçš„ç‰¹æ®Šçµæ§‹", file: "Chinese-Learning-25.html", icon: "ğŸ—ï¸" }
                ]
            },
            {
                title: "è¾¨è­˜æ–‡æ³•",
                theme: "theme-blue",
                items: [
                    { id: "L26", title: "ç¬¬ 1 ç«™", subtitle: "è©æ€§è½‰æ›ï¼ˆè½‰å“ï¼‰", file: "Chinese-Learning-26.html", icon: "ğŸ”„" },
                    { id: "L27", title: "ç¬¬ 2 ç«™", subtitle: "å¥å­çš„ç¨®é¡", file: "Chinese-Learning-27.html", icon: "ğŸ“" },
                    { id: "L28", title: "ç¬¬ 3 ç«™", subtitle: "ä¸»èªåˆ¤æ–·", file: "Chinese-Learning-28.html", icon: "ğŸ¯" }
                ]
            },
            {
                title: "æ¢ç´¢æ‡‰ç”¨æ–‡",
                theme: "theme-red",
                items: [
                    { id: "L29", title: "ç¬¬ 1 ç«™", subtitle: "æ›¸ä¿¡ã€æŸ¬å¸–", file: "Chinese-Learning-29.html", icon: "âœ‰ï¸" },
                    { id: "L30", title: "ç¬¬ 2 ç«™", subtitle: "å•Ÿäº‹ã€ä¾¿æ¢", file: "Chinese-Learning-30.html", icon: "ğŸ“Œ" },
                    { id: "L31", title: "ç¬¬ 3 ç«™", subtitle: "å°è¯ã€é¡Œè¾­", file: "Chinese-Learning-31.html", icon: "ğŸ§§" }
                ]
            },
            {
                title: "è²«é€šåœ‹å­¸å¸¸è­˜",
                theme: "theme-brown",
                items: [
                    { id: "L32", title: "ç¬¬ 1 ç«™", subtitle: "å­£ç¯€ã€ç¯€æ…¶çš„æ¯”è¼ƒ", file: "Chinese-Learning-32.html", icon: "ğŸ®" },
                    { id: "L33", title: "ç¬¬ 2 ç«™", subtitle: "å¹´é½¡ã€å¤©å¹²åœ°æ”¯", file: "Chinese-Learning-33.html", icon: "â³" },
                    { id: "L34", title: "ç¬¬ 3 ç«™", subtitle: "å„ä»£æ–‡å­¸ä¸»æµ", file: "Chinese-Learning-34.html", icon: "ğŸ“š" },
                    { id: "L35", title: "ç¬¬ 4 ç«™", subtitle: "è©©è©æ›²æ ¼å¾‹æ¯”è¼ƒ", file: "Chinese-Learning-35.html", icon: "ğŸµ" }
                ]
            },
            {
                title: "å“è³å¯«ä½œæŠ€å·§",
                theme: "theme-teal",
                items: [
                    { id: "L36", title: "ç¬¬ 1 ç«™", subtitle: "å–„ç”¨ä¿®è¾­ä¸€ï¼šç”Ÿå‹•", file: "Chinese-Learning-36.html", icon: "âœ¨" },
                    { id: "L37", title: "ç¬¬ 2 ç«™", subtitle: "å–„ç”¨ä¿®è¾­äºŒï¼šå„ªç¾", file: "Chinese-Learning-37.html", icon: "ğŸŒ¸" },
                    { id: "L38", title: "ç¬¬ 3 ç«™", subtitle: "æ¨™é»ç¬¦è™Ÿçš„ä½¿ç”¨", file: "Chinese-Learning-38.html", icon: "ï¼Œ" },
                    { id: "L39", title: "ç¬¬ 4 ç«™", subtitle: "å†—è¨€è´…å­—åˆ¤æ–·", file: "Chinese-Learning-39.html", icon: "âœ‚ï¸" },
                    { id: "L40", title: "ç¬¬ 5 ç«™", subtitle: "èªç—…åˆ¤æ–·", file: "Chinese-Learning-40.html", icon: "ğŸ©º" },
                    { id: "L41", title: "ç¬¬ 6 ç«™", subtitle: "å¯«ä½œæŠ€å·§åˆ¤æ–·", file: "Chinese-Learning-41.html", icon: "ğŸ–‹ï¸" }
                ]
            },
            {
                title: "é ˜æœƒå¥ç¾©",
                theme: "theme-green",
                items: [
                    { id: "L42", title: "ç¬¬ 1 ç«™", subtitle: "å¥å¼é‚è¼¯", file: "Chinese-Learning-42.html", icon: "ğŸ§ " },
                    { id: "L43", title: "ç¬¬ 2 ç«™", subtitle: "é›™å¥å¥ç¾©æ¯”è¼ƒ", file: "Chinese-Learning-43.html", icon: "âš–ï¸" },
                    { id: "L44", title: "ç¬¬ 3 ç«™", subtitle: "ä¿—èªã€è«ºèª", file: "Chinese-Learning-44.html", icon: "ğŸ—£ï¸" },
                    { id: "L45", title: "ç¬¬ 4 ç«™", subtitle: "èªæ°£åˆ¤æ–·", file: "Chinese-Learning-45.html", icon: "ğŸ¤”" }
                ]
            },
            {
                title: "å¡«ç©ºèˆ‡é‡çµ„",
                theme: "theme-orange",
                items: [
                    { id: "L46", title: "ç¬¬ 1 ç«™", subtitle: "ç™½è©±è©©æ–‡å¡«ç©º", file: "Chinese-Learning-46.html", icon: "âœï¸" },
                    { id: "L47", title: "ç¬¬ 2 ç«™", subtitle: "æ–‡è¨€è©©æ–‡å¡«ç©º", file: "Chinese-Learning-47.html", icon: "ğŸ–Œï¸" },
                    { id: "L48", title: "ç¬¬ 3 ç«™", subtitle: "ç™½è©±è©©æ–‡é‡çµ„", file: "Chinese-Learning-48.html", icon: "ğŸ§©" },
                    { id: "L49", title: "ç¬¬ 4 ç«™", subtitle: "æ–‡è¨€è©©æ–‡é‡çµ„", file: "Chinese-Learning-49.html", icon: "ğŸ“œ" }
                ]
            },
            {
                title: "é–±è®€åœ–æ–‡è¡¨",
                theme: "theme-indigo",
                items: [
                    { id: "L50", title: "ç¬¬ 1 ç«™", subtitle: "æ–‡å®£å»£å‘Šé–±è®€", file: "Chinese-Learning-50.html", icon: "ğŸ“¢" },
                    { id: "L51", title: "ç¬¬ 2 ç«™", subtitle: "åœ–æ–‡è¡¨å–®é¡Œ", file: "Chinese-Learning-51.html", icon: "ğŸ“Š" },
                    { id: "L52", title: "ç¬¬ 3 ç«™", subtitle: "åœ–æ–‡è¡¨é¡Œçµ„", file: "Chinese-Learning-52.html", icon: "ğŸ“ˆ" }
                ]
            },
            {
                title: "é–±è®€ç™½è©±æ–‡",
                theme: "theme-red",
                items: [
                    { id: "L53", title: "ç¬¬ 1 ç«™", subtitle: "ç™½è©±æ–‡å–®é¡Œ", file: "Chinese-Learning-53.html", icon: "ğŸ“–" },
                    { id: "L54", title: "ç¬¬ 2 ç«™", subtitle: "ç™½è©±æ–‡é¡Œçµ„", file: "Chinese-Learning-54.html", icon: "ğŸ“š" },
                    { id: "L55", title: "ç¬¬ 3 ç«™", subtitle: "æ ¸å¿ƒè­°é¡Œå–®é¡Œ", file: "Chinese-Learning-55.html", icon: "ğŸŒ" },
                    { id: "L56", title: "ç¬¬ 4 ç«™", subtitle: "æ ¸å¿ƒè­°é¡Œé¡Œçµ„", file: "Chinese-Learning-56.html", icon: "ğŸŒ" },
                    { id: "L57", title: "ç¬¬ 5 ç«™", subtitle: "17 é … SDGs å–®é¡Œ", file: "Chinese-Learning-57.html", icon: "ğŸŒ±" },
                    { id: "L58", title: "ç¬¬ 6 ç«™", subtitle: "17 é … SDGs é¡Œçµ„", file: "Chinese-Learning-58.html", icon: "ğŸŒ¿" }
                ]
            },
            {
                title: "é–±è®€è©©è©æ›²",
                theme: "theme-purple",
                items: [
                    { id: "L59", title: "ç¬¬ 1 ç«™", subtitle: "ç¾ä»£è©©å–®é¡Œ", file: "Chinese-Learning-59.html", icon: "â›…" },
                    { id: "L60", title: "ç¬¬ 2 ç«™", subtitle: "ç¾ä»£è©©é¡Œçµ„", file: "Chinese-Learning-60.html", icon: "ğŸŒ§ï¸" },
                    { id: "L61", title: "ç¬¬ 3 ç«™", subtitle: "è©©è©æ›²å–®é¡Œ", file: "Chinese-Learning-61.html", icon: "ğŸŒ™" },
                    { id: "L62", title: "ç¬¬ 4 ç«™", subtitle: "è©©è©æ›²é¡Œçµ„", file: "Chinese-Learning-62.html", icon: "ğŸ¯" }
                ]
            },
            {
                title: "é–±è®€æ–‡è¨€æ–‡",
                theme: "theme-brown",
                items: [
                    { id: "L63", title: "ç¬¬ 1 ç«™", subtitle: "æ–‡è¨€æ–‡å–®é¡Œ", file: "Chinese-Learning-63.html", icon: "ğŸ“œ" },
                    { id: "L64", title: "ç¬¬ 2 ç«™", subtitle: "æ–‡è¨€æ–‡é¡Œçµ„", file: "Chinese-Learning-64.html", icon: "ğŸ•¯ï¸" }
                ]
            },
            {
                title: "é€²éšé–±è®€ç´ é¤Š",
                theme: "theme-indigo",
                items: [
                    { id: "L65", title: "ç¬¬ 1 ç«™", subtitle: "ç™½è©±æ–‡é›™æ–‡", file: "Chinese-Learning-65.html", icon: "ğŸ‘“" },
                    { id: "L66", title: "ç¬¬ 2 ç«™", subtitle: "å¤ä»Šé›™æ–‡", file: "Chinese-Learning-66.html", icon: "âš–ï¸" },
                    { id: "L67", title: "ç¬¬ 3 ç«™", subtitle: "æ–‡è¨€æ–‡é›™æ–‡", file: "Chinese-Learning-67.html", icon: "ğŸ“" }
                ]
            }
        ];

        /* ================= Firebase åˆå§‹åŒ– ================= */
        // â˜… ä¿®æ­£é‡é»ï¼šæä¾›é è¨­ç‰©ä»¶ï¼Œé¿å…æœ¬åœ°ç«¯åŸ·è¡Œæ™‚æ‰¾ä¸åˆ° __firebase_config è€Œç•¶æ©Ÿ
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
          apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
          authDomain: "chinese-learning-47f4d.firebaseapp.com",
          projectId: "chinese-learning-47f4d",
          storageBucket: "chinese-learning-47f4d.firebasestorage.app",
          messagingSenderId: "76289812052",
          appId: "1:76289812052:web:898384a916f9f341f62fc1"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // è³‡æ–™åº«è·¯å¾‘ helper
        const getPublicRef = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);
        const getUserRef = (uid, col) => collection(db, 'artifacts', appId, 'users', uid, col);

        /* ================= Components ================= */

        // ç‹€æ…‹ç‡ˆè™Ÿ
        const StatusLight = ({ status }) => {
            let dotClass = 'status-loading';
            let text = 'é€£ç·šä¸­...';

            if (status === 'success') {
                dotClass = 'status-success';
                text = 'å·²åŒæ­¥';
            } else if (status === 'error') {
                dotClass = 'status-error';
                text = 'åŒæ­¥å¤±æ•—';
            } else if (status === 'loading') {
                dotClass = 'status-loading';
                text = 'è®€å–è³‡æ–™ä¸­...';
            } else {
                dotClass = 'status-offline'; 
                text = 'é›¢ç·šæ¨¡å¼';
            }

            return (
                <div className="flex items-center text-xs text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm border border-gray-100 backdrop-blur-sm bg-opacity-90">
                    <span className={`status-dot ${dotClass}`}></span>
                    {text}
                </div>
            );
        };

        // åµŒå…¥å¼ç™»å…¥çµ„ä»¶ (å–ä»£å…¨é  LoginScreen)
        const UserLoginWidget = ({ onLogin, usersList }) => {
            const [newUsername, setNewUsername] = useState("");
            const [isCreating, setIsCreating] = useState(false);

            const handleCreate = async () => {
                if (!newUsername.trim()) return;
                setIsCreating(true);
                await onLogin(newUsername.trim(), true);
                setIsCreating(false);
            };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 max-w-lg w-full mx-auto text-left relative z-10">
                    <h2 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span className="text-2xl">ğŸ‘‹</span> èª°è¦é–‹å§‹ä¿®ç…‰ï¼Ÿ
                    </h2>
                    
                    {/* ç¾æœ‰ä½¿ç”¨è€…åˆ—è¡¨ (Quick Login) */}
                    <div className="space-y-2 mb-6 max-h-48 overflow-y-auto pr-2 custom-scrollbar">
                        {usersList.length === 0 ? (
                            <p className="text-center text-gray-400 py-4 text-sm bg-gray-50 rounded-lg">
                                ç›®å‰å°šç„¡æŒ‘æˆ°ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€ä½æŒ‘æˆ°è€…å§ï¼
                            </p>
                        ) : (
                            usersList.map((user) => (
                                <button
                                    key={user.uid}
                                    onClick={() => onLogin(user, false)}
                                    className="w-full flex items-center justify-between p-3 rounded-lg hover:bg-purple-50 border border-transparent hover:border-purple-200 transition-all text-left group"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-sm">
                                            {user.name.charAt(0)}
                                        </div>
                                        <span className="font-bold text-gray-700">{user.name}</span>
                                    </div>
                                    <span className="text-xs text-gray-400 group-hover:text-purple-600">é€²å…¥ &rarr;</span>
                                </button>
                            ))
                        )}
                    </div>

                    {/* å»ºç«‹æ–°ä½¿ç”¨è€… */}
                    <div className="pt-4 border-t border-gray-100">
                        <label className="text-xs text-gray-400 mb-2 block">æˆ–å»ºç«‹æ–°æŒ‘æˆ°è€…</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newUsername}
                                onChange={(e) => setNewUsername(e.target.value)}
                                placeholder="è¼¸å…¥æ‚¨çš„åå­—"
                                className="flex-1 px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                onKeyPress={(e) => e.key === 'Enter' && handleCreate()}
                            />
                            <button
                                onClick={handleCreate}
                                disabled={!newUsername.trim() || isCreating}
                                className="px-4 py-2 bg-purple-700 text-white text-sm rounded-lg font-bold hover:bg-purple-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                            >
                                {isCreating ? 'å»ºç«‹ä¸­...' : 'é–‹å§‹'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // èª²ç¨‹å¡ç‰‡çµ„ä»¶
        const LessonCard = ({ item, theme, isCompleted, onToggle }) => {
            return (
                <div 
                    onClick={(e) => {
                        // é˜²æ­¢é»æ“Šé€£çµæ™‚è§¸ç™¼ Toggle (å¦‚æœæœªä¾†æŠŠ div æ›å› a tag)
                        // ä½†ç¾åœ¨æˆ‘å€‘æ˜¯ç”¨ div wrapï¼Œé»æ“Šæ•´å¼µå¡ç‰‡éƒ½ toggle æ¯”è¼ƒç›´è¦º
                        onToggle();
                    }}
                    className={`app-card ${theme} theme-item ${isCompleted ? 'completed' : ''} group select-none`}
                >
                    {/* æ ¸å–æ–¹å¡Š (è¦–è¦ºè¼”åŠ©) */}
                    <div className="absolute top-3 right-3 z-20">
                        <div className="check-circle">
                            {isCompleted && <span className="text-sm font-bold">âœ“</span>}
                        </div>
                    </div>

                    <div className="card-icon group-hover:scale-110 transition-transform duration-300">
                        {item.icon}
                    </div>
                    
                    <div className="card-title text-center text-lg mb-2">
                        {item.title}<br/>
                        <span className="text-base font-normal opacity-90">{item.subtitle}</span>
                    </div>
                    
                    <div className="card-desc text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded mb-4 font-mono">
                        {item.file}
                    </div>

                    <div className={`card-badge rounded-full px-3 py-1 text-xs font-bold tracking-wider text-white mt-auto ${isCompleted ? '' : 'bg-green-600'}`}>
                        {isCompleted ? 'å·²å®Œæˆ' : 'é€²å…¥å­¸ç¿’'}
                    </div>

                    {/* éš±è—çš„å¯¦éš›é€£çµï¼Œé»æ“Šå¡ç‰‡æ™‚å¯ä»¥é¸æ“‡æ˜¯å¦è¦è·³è½‰ï¼Œæˆ–è€…ç´”ç´€éŒ„é€²åº¦ */}
                    {/* é€™è£¡è¨­è¨ˆç‚ºï¼šé»æ“Šå¡ç‰‡åˆ‡æ›ç‹€æ…‹ï¼Œä¸¦éç›´æ¥è·³è½‰ï¼Œè®“ä½¿ç”¨è€…ä½œç‚º Checkbox List ä½¿ç”¨ */}
                    {/* è‹¥éœ€è¦è·³è½‰ï¼Œå¯ä»¥æŠŠ onClick æ”¹æˆ window.location.hrefï¼Œä½†é¡Œç›®è¦æ±‚ "æ‰‹å‹•æ ¸å–æ–¹å¡Š" */}
                </div>
            );
        };

        // ä¸»ç¨‹å¼
        const App = () => {
            const [user, setUser] = useState(null); // Firebase Auth User
            const [currentProfile, setCurrentProfile] = useState(null); // App å…§é¸æ“‡çš„èº«åˆ† { name, uid }
            const [usersList, setUsersList] = useState([]); // æ‰€æœ‰ä½¿ç”¨è€…åˆ—è¡¨
            const [progress, setProgress] = useState({}); // å€‹äººé€²åº¦ { lessonId: true }
            const [status, setStatus] = useState('loading'); // é€£ç·šç‹€æ…‹

            // 1. åˆå§‹åŒ– Auth & ç›£è½å…¨åŸŸä½¿ç”¨è€…åˆ—è¡¨
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setStatus('error');
                    }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        // ç›£è½å…¬å…±ä½¿ç”¨è€…åˆ—è¡¨
                        const listRef = doc(getPublicRef('user_directory'), 'all_users');
                        const unsubList = onSnapshot(listRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setUsersList(docSnap.data().list || []);
                            } else {
                                // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¨­ç‚ºç©ºé™£åˆ— (ç¬¬ä¸€æ¬¡ä½¿ç”¨)
                                setUsersList([]);
                            }
                            setStatus('success');
                        }, (err) => {
                            console.error("List Fetch Error:", err);
                            setStatus('error');
                        });
                        return () => unsubList();
                    }
                });

                return () => unsubscribeAuth();
            }, []);

            // 2. ç›£è½å€‹äººé€²åº¦ (ç•¶ currentProfile æ”¹è®Šæ™‚)
            useEffect(() => {
                if (!user || !currentProfile) return;

                setStatus('loading');
                const progressRef = doc(getUserRef(currentProfile.uid, 'user_progress'), 'main');
                
                const unsubProgress = onSnapshot(progressRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setProgress(docSnap.data().completed || {});
                    } else {
                        setProgress({});
                    }
                    setStatus('success');
                }, (err) => {
                    console.error("Progress Sync Error:", err);
                    setStatus('error');
                });

                return () => unsubProgress();
            }, [user, currentProfile]);

            // è™•ç†ç™»å…¥ / å»ºç«‹æ–°ç”¨æˆ¶
            const handleLogin = async (userDataOrName, isNew) => {
                if (!user) return;

                if (isNew) {
                    const newProfile = {
                        name: userDataOrName,
                        uid: crypto.randomUUID(), // ç”Ÿæˆä¸€å€‹è™›æ“¬ ID ä¾†å€åˆ†ä¸åŒä½¿ç”¨è€… (éƒ½åœ¨åŒä¸€å€‹ Auth å¸³è™Ÿä¸‹ç®¡ç†)
                        createdAt: new Date().toISOString()
                    };
                    
                    // æ›´æ–°å…¨åŸŸåˆ—è¡¨
                    const listRef = doc(getPublicRef('user_directory'), 'all_users');
                    try {
                        // æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡å»ºç«‹
                        const docSnap = await getDoc(listRef);
                        if (!docSnap.exists()) {
                            await setDoc(listRef, { list: [newProfile] });
                        } else {
                            await updateDoc(listRef, {
                                list: arrayUnion(newProfile)
                            });
                        }
                        setCurrentProfile(newProfile);
                    } catch (e) {
                        console.error("Create User Error:", e);
                        alert("å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
                    }
                } else {
                    // é¸æ“‡æ—¢æœ‰ç”¨æˆ¶
                    setCurrentProfile(userDataOrName);
                }
            };

            const handleLogout = () => {
                setCurrentProfile(null);
                setProgress({});
            };

            // åˆ‡æ›å®Œæˆç‹€æ…‹
            const toggleProgress = async (lessonId) => {
                if (!currentProfile) return;
                
                const newStatus = !progress[lessonId];
                // æ¨‚è§€æ›´æ–° (UI First)
                const newProgress = { ...progress, [lessonId]: newStatus };
                setProgress(newProgress);

                // å¯«å…¥ Firestore
                try {
                    const progressRef = doc(getUserRef(currentProfile.uid, 'user_progress'), 'main');
                    await setDoc(progressRef, { completed: newProgress }, { merge: true });
                } catch (e) {
                    console.error("Save Progress Error:", e);
                    setStatus('error');
                    // å›æ»¾
                    setProgress({ ...progress, [lessonId]: !newStatus });
                }
            };

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalLessons = ALL_CATEGORIES.reduce((acc, cat) => acc + cat.items.length, 0);
            const completedCount = Object.values(progress).filter(Boolean).length;
            const progressPercentage = Math.round((completedCount / totalLessons) * 100);

            // æ¸²æŸ“ï¼šä¸»æ§å° (ç¾åœ¨åŒ…å«ç™»å…¥å¾Œçš„å…§å®¹èˆ‡ç™»å…¥å‰çš„ Widget)
            return (
                <div className="flex flex-col items-center min-h-screen pb-20">
                    {/* Header Area */}
                    <header className="w-full max-w-4xl px-6 pt-10 pb-6 text-center relative">
                        {/* ç‹€æ…‹åˆ— (å³ä¸Šè§’) */}
                        <div className="absolute top-4 right-4 flex gap-2">
                            <StatusLight status={status} />
                            {currentProfile && (
                                <button onClick={handleLogout} className="text-xs text-gray-400 hover:text-red-500 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm transition-colors">
                                    ç™»å‡º
                                </button>
                            )}
                        </div>

                        {/* Title (Always visible) */}
                        <h1 className="text-4xl md:text-5xl font-serif font-black text-gray-800 mb-2 tracking-wide" style={{ textShadow: '2px 2px 0px rgba(0,0,0,0.1)' }}>
                            ğŸ“œ åœ‹æ–‡å­¸ç¿’ç¸½éƒ¨
                        </h1>

                        {/* Conditional Header Content: Login Widget OR Welcome+Progress */}
                        {!currentProfile ? (
                            <div className="mt-8 mb-8">
                                <p className="text-[#5d4037] text-lg font-medium mb-6">å“å‘³æ–‡å­—çš„å¥§å¦™ï¼Œç©¿æ¢­å¤ä»Šçš„æ–‡å­¸ä¹‹æ—…</p>
                                <UserLoginWidget onLogin={handleLogin} usersList={usersList} />
                            </div>
                        ) : (
                            <>
                                <p className="text-[#5d4037] text-lg font-medium mb-8">
                                    æ­¡è¿å›ä¾†ï¼Œ<span className="font-bold text-purple-700">{currentProfile.name}</span>ï¼ å“å‘³æ–‡å­—çš„å¥§å¦™
                                </p>

                                {/* é€²åº¦æ¢ */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-8 max-w-lg mx-auto">
                                    <div className="flex justify-between items-end mb-2">
                                        <span className="text-sm font-bold text-gray-500">ç›®å‰ä¿®ç…‰é€²åº¦</span>
                                        <span className="text-2xl font-black text-purple-700 font-mono">
                                            {completedCount} <span className="text-sm text-gray-400">/ {totalLessons}</span>
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                        <div 
                                            className="bg-gradient-to-r from-purple-500 to-indigo-600 h-full rounded-full transition-all duration-1000 ease-out"
                                            style={{ width: `${progressPercentage}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </>
                        )}

                        <a href="https://nicktsai88.github.io/List/" className="inline-flex items-center gap-2 bg-gradient-to-br from-purple-700 to-indigo-800 text-white px-8 py-3 rounded-full font-bold hover:shadow-lg hover:-translate-y-1 transition-all border-2 border-white shadow-md">
                            ğŸ è¿”å›å¿«æ¨‚å­¸ç¿’ç™¾å¯¶ç®±
                        </a>
                    </header>

                    {/* Main Content (Only if logged in) */}
                    {currentProfile && (
                        <main className="w-full max-w-6xl px-4 animate-fade-in-up">
                            {ALL_CATEGORIES.map((category, idx) => (
                                <div key={idx} className="mb-8">
                                    <div className="divider">{category.title}</div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                        {category.items.map((item) => (
                                            <LessonCard 
                                                key={item.id}
                                                item={item}
                                                theme={category.theme}
                                                isCompleted={!!progress[item.id]}
                                                onToggle={() => toggleProgress(item.id)}
                                            />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </main>
                    )}

                    <footer className="text-center text-gray-400 text-sm mt-12 mb-8">
                        åœ‹æ–‡å­¸ç¿’ App &copy; {new Date().getFullYear()} All Rights Reserved.
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>